---
title: "Final ML Runs"
output: html_notebook
---

This notebook runs the complete hurdle models for RFMO dataset.

```{r message=FALSE, warning=FALSE, include=FALSE}
# General
library(raster)
library(sf)
library(fasterize)
library(scales)
library(knitr)
library(RColorBrewer)
library(readxl)
library(googledrive)
library(cowplot)
library(tidyverse)
library(sp)
library(rgdal)
library(geosphere)
library(paletteer)

# Neg Binomial Libraries
library(pscl)

# ML Libraries
library(tidymodels)
library(readr)
library(broom.mixed)
library(MultivariateRandomForest)
library(vroom)

options(scipen = 1000000)

# Get functions
source("../functions/func-all_rfmo_models.R")
source("../functions/func-all_rfmo_effort_models.R")
source("../functions/func-train_all_models.R")
source("../functions/func-train_test_split.R")

save_loc = "../../data/model-data/outputs/all-rfmo-models/"
```

```{r include=FALSE}
# Read in data... 
# 5x5 data - count only
count_5x5_obs <- read.csv("../../data/model-data/inputs/all-rfmo-models/global_ll_data_5x5_count_hooks.csv") %>% 
  bind_rows(read.csv("../../data/model-data/inputs/wcpfc-only-model/wcpfc_all.csv") %>% # add wcpfc data (previously cleaned)
              filter(gear == "longline" & 
              catch_units == "count" & 
              effort_units == "hooks") %>% 
              mutate_if(is_character, as.factor) %>% 
              arrange(year, latitude, longitude) %>%
              filter(target_sources == "self-reported catch and effort by flag + year") %>%
              mutate(rfmo = "WCPFC") %>% 
              rename(gear_group = gear) %>% 
              select(rfmo, year, latitude, longitude, species_sciname, catch, catch_units, gear_group, effort_units, 
                     spatial_notes, species_commonname, species_group, 
                     colnames(.)[grepl("target_effort", colnames(.)) & grepl("longline", colnames(.))])) %>% 
  mutate_at(vars(target_effort:bycatch_total_effort_Indonesia_longline, 
                 target_effort_Cook.Islands_longline:target_effort_Samoa_longline),
            replace_na, 0)
count_5x5_gfw <- read.csv("../../data/model-data/inputs/all-rfmo-models/global_ll_data_5x5_count_kwh.csv") %>%
  bind_rows(read.csv("../../data/model-data/inputs/wcpfc-only-model/wcpfc_all.csv") %>% # add wcpfc data (previously cleaned)
              filter(gear == "longline" & 
              catch_units == "count" & 
              effort_units == "hooks") %>% 
              mutate_if(is_character, as.factor) %>% 
              arrange(year, latitude, longitude) %>%
              filter(target_sources == "self-reported catch and effort by flag + year") %>%
              mutate(rfmo = "WCPFC") %>% 
              rename(gear_group = gear) %>% 
              select(rfmo, year, latitude, longitude, species_sciname, catch, catch_units, gear_group, effort_units, 
                     spatial_notes, species_commonname, species_group, total_fishing_kwh))

data = count_5x5_gfw
effort_source = "gfw effort"
rfmos = "WCPFC"

# 5x5 data - mt and count (no wcpfc data because all data are count)
mt_5x5_obs <- read.csv("../../data/model-data/inputs/all-rfmo-models/global_ll_data_5x5_mt_to_count_hooks.csv") 
mt_5x5_gfw <- read.csv("../../data/model-data/inputs/all-rfmo-models/global_ll_data_5x5_mt_to_count_kwh.csv") 

# 1x1 data - count only
count_1x1_obs <- read.csv("../../data/model-data/inputs/all-rfmo-models/global_ll_data_1x1_count_hooks.csv") %>% 
  bind_rows(read.csv("../../data/model-data/inputs/wcpfc-only-model/wcpfc_1x1_hooks.csv")) %>% # add wcpfc data (previously cleaned)
  mutate_at(vars(target_effort:bycatch_total_effort_Indonesia_longline, target_effort_Cook.Islands_longline:target_effort_Samoa_longline),
            replace_na, 0)
count_1x1_gfw <- read.csv("../../data/model-data/inputs/all-rfmo-models/global_ll_data_1x1_count_kwh.csv") %>% 
  bind_rows(read.csv("../../data/model-data/inputs/wcpfc-only-model/wcpfc_1x1_kwh.csv")) # add wcpfc data (previously cleaned)

# 1x1 data - mt and count (no wcpfc data because all data are count)
mt_1x1_obs <- read.csv("../../data/model-data/inputs/all-rfmo-models/global_ll_data_1x1_mt_to_count_hooks.csv")
mt_1x1_gfw <- read.csv("../../data/model-data/inputs/all-rfmo-models/global_ll_data_1x1_mt_to_count_kwh.csv") 
```

```{r eval=FALSE, include=FALSE}
# Run effort scenarios... 
# 5x5 data - count only
results_5x5_count <- all_rfmo_effort_models(data_gfw = count_5x5_gfw, data_effort = count_5x5_obs, save_loc = paste0(save_loc, "5x5_count_"))

# 5x5 data - mt and count
results_5x5_mt <- all_rfmo_effort_models(data_gfw = mt_5x5_gfw, data_effort = mt_5x5_obs, save_loc = paste0(save_loc, "5x5_mt_to_count_"))

# 1x1 data - count only
results_1x1_count <- all_rfmo_effort_models(data_gfw = count_1x1_gfw, data_effort = count_1x1_obs, save_loc = paste0(save_loc, "1x1_count_"))

# 1x1 data - mt and count
results_1x1_mt <- all_rfmo_effort_models(data_gfw = mt_1x1_gfw, data_effort = mt_1x1_obs, save_loc = paste0(save_loc, "1x1_mt_to_count_"))
```


```{r}
# Find best performing models
all_model_results <- results_5x5_count %>% 
  mutate(option = "5x5, count only") %>% 
  bind_rows(results_5x5_mt %>% 
              mutate(option = "5x5, mt to count")) %>% 
  bind_rows(results_1x1_count %>% 
              mutate(option = "1x1, count only")) %>% 
  bind_rows(results_1x1_mt %>% 
              mutate(option = "1x1, mt to count")) 

all_model_results %>% 
  group_by(rfmo) %>% 
  slice_max(., rsq)
```

```{r}
# Run the best performing model and return a full prediction for that RFMO
# IOTC
all_rfmo_models(data = count_1x1_obs, rfmos = "IOTC", effort_source = "effort reported with bycatch (flag)", save_loc = save_loc)

# ICCAT
all_rfmo_models(data = count_1x1_obs, rfmo = "ICCAT", effort_source = "effort reported with target catch (flag)", save_loc = save_loc)

# IATTC
all_rfmo_models(data = mt_1x1_obs, rfmo = "IATTC", effort_source = "effort reported with bycatch (flag)", save_loc = save_loc)

# WCPFC
all_rfmo_models(data = count_5x5_obs, rfmo = "WCPFC", effort_source = "effort reported with target catch (flag)", save_loc = save_loc)

t <- readRDS(file.path(save_loc, "IOTC_ll_final_model.rds"))
```


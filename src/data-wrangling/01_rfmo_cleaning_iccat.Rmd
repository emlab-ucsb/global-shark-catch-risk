---
title: "RFMO Data Cleaning - ICCAT"
output: html_notebook
---

This is a notebook designed to grab data saved in Google Drive and re-format it for easier analyses later.

ICCAT data were mostly in Microsoft Access databases, so I had to export the queries into csv files for import.

# Table of Contents: {#top}

- [T2CE Web]
- [T2CE By Schools]
- [CDIS Data]
- [Nominal Catch Data]
- [New Data]
- [Combining Files]

```{r, include=FALSE}
# Import libraries
library(tidyverse)
library(readxl)
library(reshape)
```

# Housekeeping
```{r, echo=TRUE}
# List files to choose from
file_path = "../../data/rfmo-observer-data/inputs/iccat/"
save_location = "../../data/rfmo-observer-data/intermediates/iccat/"
outputs_location = "../../data/rfmo-observer-data/outputs/"
```

# Load Catch Data
```{r, echo=TRUE}
# Load t2ce web
file_list <- list.files(file_path, pattern=".csv")
file_list <- file_list[grepl("t2ce", file_list)]

t2ce_web <- NULL
for(file in file_list) { 
  temp <- read.csv(paste0(file_path, file))
  t2ce_web <- rbind(t2ce_web, temp)
}

remove(temp)

# Load t2ce size
file_list <- c(list.files(paste0(file_path), pattern = "t2sz"), "Species.xlsx")
file_list <- file_list[grepl(".xlsx", file_list)]

for(file in file_list) { 
  name <- colsplit(file, "[.]", c("name", ""))[,1]
  name <- paste0("size_", name)
  temp <- read_xlsx(paste0(file_path, file))
  assign(name, temp)
}

remove(temp)

# Load t2ce by school
t2ce_school <- read_xlsx(paste0(file_path, "t2ce_PS91-18_bySchool.xlsx"), sheet="dsT2CE_PS-ETRO_91-18", skip=6)

# Load cdis
cdis <- read.csv(paste0(file_path, "cdis5017-all9sp.csv"))
```

# Load Coded Files
```{r, echo=TRUE}
# Load gear codes
# Currently used gear
gear <- read_xls(paste0(file_path, "CODES_Gears.xls"), skip=2)
gear <- gear[,c(1:3)]

# Historically used gear
historic_gear <- read_xls(paste0(file_path, "CODES_Gears.xls"), skip=51, col_names = colnames(gear))

# Combine gears
gear <- rbind(gear, historic_gear)
remove(historic_gear)

# Gear group codes
gear_groups <- read_xls(paste0(file_path, "CODES_Gears.xls"), skip=2)
gear_groups <- gear_groups[, c("Code", "Name")] %>% distinct_all()

# Load species codes
species <- read_xlsx(paste0(file_path, "CODES_Species.xlsx"), skip=1)

# Load time period codes
time_periods <- read_xls(paste0(file_path, "CODES_TimePeriods.xls"), skip=2)

# Load effort types
effort_types <- read_xls(paste0(file_path, "CODES_EffortTypes.xls"), skip=2)
```

# T2CE Web
From the readme: This document provides a summarized description of the Task II Catch and Effort statistics (T2CE) published on the ICCAT website and also explains the changes in structure of the information published. In addition, it briefly describes the applications available to extract T2CE information. The information published (pertaining to 1950 through to 2007) is only the T2CE reported by the CPCs to ICCAT (Contracting and Cooperating non-Contracting Parties, Entities or Fishing Entities) and some other non-Cooperating Parties.
```{r, echo=TRUE}
# Keep only data from the year 2000 onward
t2ce_web <- t2ce_web %>% 
  filter(YearC >= 2000)

# Pivot tables so each row represents a different species
t2ce_web <- t2ce_web %>% 
  pivot_longer(cols=BFT:oSks, names_to = 'SpeciesCode', values_to = 'MonthlyCatch') %>% 
  filter(MonthlyCatch > 0)

# Reform data so different effort types are in different rows
t2ce_web_eff1 <- t2ce_web[,-c(15:16)]
t2ce_web_eff2 <- t2ce_web[,-c(13:14)]
colnames(t2ce_web_eff1)[13:14] <- c("Effort", "EffortType")
colnames(t2ce_web_eff2)[13:14] <- c("Effort", "EffortType")
t2ce_web <- rbind(t2ce_web_eff1, t2ce_web_eff2)
remove(t2ce_web_eff1, t2ce_web_eff2)

# Join with other datasets
t2ce_web <- t2ce_web %>% 
  left_join(gear_groups, by=c("GearGrpCode" = "Code")) %>%
  left_join(effort_types[,c("EffortTypeCode", "EffortTypeName")], by=c("EffortType" = "EffortTypeCode")) %>%
  left_join(species[,c("SpeciesCode", "ScieName", "English")], by="SpeciesCode") %>% 
  left_join(time_periods, by="TimePeriodID")

# Fix some effort values
t2ce_web <- t2ce_web %>% 
  mutate(EffortTypeName = ifelse(is.na(EffortTypeName), EffortType, EffortTypeName),
         EffortType = toupper(EffortType),
         EffortTypeName = ifelse(EffortType == "NO.NETS", "number of nets", EffortTypeName),
         EffortTypeName = ifelse(EffortType == "NO.MTZAS", "number of MTZAS", EffortTypeName),
         EffortTypeName = ifelse(EffortType == "NO.FADS.VIS", "number of FAD vis", EffortTypeName), 
         EffortTypeName = ifelse(EffortType == "KM.SETS", "kilometers of set", EffortTypeName),
         EffortTypeName = ifelse(EffortType == "HOURS.SEA", "hours at sea", EffortTypeName))

# Add names for species that are not in the species list
t2ce_web <- t2ce_web %>% 
  mutate(English = ifelse(SpeciesCode == "oSks", "other sharks", 
                          ifelse(SpeciesCode == "oTun", "other tuna", English)))

# Make all names uppercase
t2ce_web$ScieName<- toupper(t2ce_web$ScieName)
t2ce_web$English<- toupper(t2ce_web$English)

# Fix latlon coordinates based on QuadID
# From readme file -- 1: NE, 2:SE, 3: SW, 4:NW
t2ce_web <- t2ce_web %>% 
  filter(Lat <= 90) %>%
  mutate(Lon = ifelse(QuadID == 3 | QuadID == 4, Lon*(-1), Lon), 
         Lat = ifelse(QuadID == 2 | QuadID == 3, Lat*(-1), Lat))

# Format relevant columns
t2ce_web <- t2ce_web %>% 
  mutate(rfmo = "ICCAT", 
         year = YearC, 
         month = TimePeriodID, 
         time_period = TPeriodGroup,
         country = FlagName, 
         gear = Name, 
         settype = SchoolTypeCode, 
         longitude = Lon,
         latitude = Lat, 
         effort = Effort, 
         effort_units = EffortTypeName, 
         species_commonname = English, 
         species_sciname = ScieName, 
         is_targeted = ifelse(grepl("TUNA", English), "yes-implied", "no"),
         catch = MonthlyCatch, 
         catch_units = CatchUnit, 
         measurement = NA, 
         measurement_unit = NA, 
         measurement_method = NA, 
         spatial_notes = paste0("center of ", SquareTypeCode, " cell"), 
         quality_code = NA, 
         was_generated = "no", 
         sources = NA)

# Keep only relevant columns
t2ce_web <- t2ce_web[,c("rfmo", "year", "month", "time_period", "country", "gear", "settype", "longitude", "latitude", "effort", "effort_units", "species_commonname", "species_sciname", "is_targeted", "catch", "catch_units", "measurement", "measurement_unit", "measurement_method", "spatial_notes", "quality_code", "was_generated", "sources")]

# Make column values consistent with other datasets 
# Countries
t2ce_web  <- t2ce_web %>% 
  mutate(country = gsub("C\xf4te d'Ivoire", "Côte d'Ivoire", country), 
         country = gsub("U.S.A.", "United States", country),
         country = gsub("Espa\xf1a", "España", country), 
         country = gsub("China PR", "China", country), 
         country = gsub("Korea Rep.", "Korea", country), 
         country = gsub("Guin\xe9e Rep.", "Guinée Rep.", country),
         country = gsub("Cura\xe7ao", "Curaçao", country), 
         country = gsub("UK|EU|FR|[.]", "", country), 
         country = gsub("&", "and", country)
         )

# Gears
t2ce_web  <- t2ce_web %>% 
  mutate(gear = gsub("purse seine", "purse-seine", gear), 
         gear = gsub("rood & reel", "rod-and-reel", gear), 
         gear = gsub("U", "u", gear), 
         gear = gsub("trammerl", "trammel", gear)
         )

# Settype
t2ce_web  <- t2ce_web %>% 
  mutate(settype = gsub("n/a", NA, settype), 
         settype = gsub("FSC", "free schools", settype))

# Effort units
t2ce_web  <- t2ce_web %>% 
  mutate(effort_units = gsub("Number of ", "", effort_units), 
         effort_units = gsub("hooks used", "hooks", effort_units), 
         effort_units = gsub("days fishing", "fishing days", effort_units),
         effort_units = gsub("Line days", "fishing days ", effort_units),
         effort_units = gsub(" \\(.*\\)", "", effort_units), 
         effort_units = gsub("used", "", effort_units), 
         effort_units = gsub("-", " ", effort_units), 
         effort_units = gsub("P", "p", effort_units), 
         effort_units = gsub("made", "", effort_units), 
         effort_units = gsub("sets", "number of sets", effort_units),
         effort_units = str_trim(as.character(effort_units), side="both"), 
         effort_units = gsub("none", NA, effort_units), 
         effort_units = ifelse(effort_units == "", NA, effort_units)
         )

# Months and time periods
t2ce_web <- t2ce_web %>% 
  mutate(month = gsub(17, NA, month), 
         month = gsub(13, 1, month), 
         month = gsub(14, 4, month), 
         month = gsub(15, 7, month), 
         month = gsub(16, 10, month),
         month = as.numeric(month),
         time_period = tolower(time_period),
         time_period = gsub("month", "monthly", time_period), 
         time_period = gsub("trimester", "quarterly", time_period))

# Catch units (and catches to convert kg to metric tonnes)
# 1 metric tonne = 1000 kg 
t2ce_web <- t2ce_web %>% 
  mutate(catch_units = gsub("nr", "count", catch_units), 
         catch = ifelse(catch_units == "kg", catch/1000, catch), 
         catch_units = gsub("kg", "metric tonnes", catch_units)
         )

# Generate data
# Generate quarterly data (aggregates)
quart_agg <- t2ce_web %>% 
  filter(time_period == "monthly") %>%
  mutate(month = ceiling(month/3),
         month = ifelse(month == 1, 1, # fix so each quarter == first month of quarter
                        ifelse(month == 2, 4, 
                               ifelse(month == 3, 7, 10))),
         time_period = "quarterly", 
         was_generated = "yes") %>% 
  group_by_at(setdiff(names(t2ce_web), c("catch", "effort"))) %>%
  summarise(catch = sum(catch), 
            effort = sum(effort))

# Generate yearly data (aggregates)
yearly_agg <- t2ce_web %>% 
  filter(time_period == "monthly") %>%
  mutate(month = NA,
         time_period = "yearly", 
         was_generated = "yes") %>% 
  group_by_at(setdiff(names(t2ce_web), c("catch", "effort"))) %>%
  summarise(catch = sum(catch), 
            effort = sum(effort))

# Combine raw with generated data
t2ce_web <- t2ce_web %>% 
  bind_rows(quart_agg) %>% 
  bind_rows(yearly_agg)

# Save File
filename <- "t2ce_web.csv"
write.csv(t2ce_web, paste0(save_location, filename), row.names = FALSE)

# Clean up
remove(t2ce_web, quart_agg, yearly_agg)
```
[Back To Top](#top)

# T2CE By Schools
```{r}
# Keep only data from the year 2000 onward
t2ce_school <- t2ce_school %>% 
  filter(YearC >= 2000)

# Pivot tables so each row represents a different species
t2ce_school <- t2ce_school %>% 
  pivot_longer(cols=YFT:FRI, names_to = 'SpeciesCode', values_to = 'MonthlyCatch') %>% 
  filter(MonthlyCatch > 0)

# Reform data so different effort types are in different rows
t2ce_school <- bind_rows(list(t2ce_school %>% 
                         mutate(effort = Eff1,
                                effort_units = Eff1Type),
                       t2ce_school %>% 
                         mutate(effort = Eff2,
                                effort_units = Eff2Type),
                       t2ce_school %>% 
                         mutate(effort = Eff3,
                                effort_units = Eff3Type),
                       t2ce_school %>% 
                         mutate(effort = Eff4,
                                effort_units = Eff4Type),             
                       t2ce_school %>% 
                         mutate(effort = Eff5,
                                effort_units = Eff5Type)))

# Join with other datasets
t2ce_school <- t2ce_school %>% 
  left_join(gear_groups, by=c("GearCode" = "Code")) %>%
  left_join(effort_types[,c("EffortTypeCode", "EffortTypeName")], by=c("effort_units" = "EffortTypeCode")) %>%
  left_join(species[,c("SpeciesCode", "ScieName", "English")], by="SpeciesCode") %>% 
  left_join(time_periods, by="TimePeriodID")

# Fix some effort values
t2ce_school <- t2ce_school %>% 
  mutate(EffortTypeName = ifelse(is.na(EffortTypeName), effort_units, EffortTypeName),
         effort_units = toupper(effort_units),
         EffortTypeName = ifelse(effort_units == "HOURS.STD", "hours std", EffortTypeName), 
         EffortTypeName = ifelse(effort_units == "HOURS.FAD", "FAD hours", EffortTypeName), 
         EffortTypeName = ifelse(effort_units == "HOURS.FSC", "free school hours", EffortTypeName),
         EffortTypeName = ifelse(effort_units == "HOURS.SEA", "hours at sea", EffortTypeName)
         )

# Make all names uppercase
t2ce_school$ScieName<- toupper(t2ce_school$ScieName)
t2ce_school$English<- toupper(t2ce_school$English)

# Format relevant columns
t2ce_school <- t2ce_school %>% 
  mutate(rfmo = "ICCAT", 
         year = YearC, 
         month = TimePeriodID, 
         time_period = TPeriodGroup,
         country = Flag, 
         gear = Name, 
         settype = FishMode, 
         longitude = xLon,
         latitude = yLat, 
         effort_units = EffortTypeName,
         species_commonname = English, 
         species_sciname = ScieName, 
         is_targeted = ifelse(grepl("TUNA", English), "yes-implied", "no"),
         catch = MonthlyCatch/1000, # catch is in kg, let's convert to tonnes 
         catch_units = "metric tonnes", 
         measurement = NA, 
         measurement_unit = NA, 
         measurement_method = NA, 
         spatial_notes = paste0("center of ", GeoStrataCode, " cell"),
         quality_code = NA, 
         was_generated = "no", 
         sources = NA
         )

# Keep only relevant columns
t2ce_school <- t2ce_school[,c("rfmo", "year", "month", "time_period", "country", "gear", "settype", "longitude", "latitude", "effort", "effort_units", "species_commonname", "species_sciname", "is_targeted", "catch", "catch_units", "measurement", "measurement_unit", "measurement_method", "spatial_notes", "quality_code", "was_generated", "sources")]

# Make column values consistent with other datasets 
# Countries
t2ce_school  <- t2ce_school %>% 
  mutate(country = gsub("UK|EU|FR|[.]", "", country))

# Gears
t2ce_school  <- t2ce_school %>% 
  mutate(gear = gsub("purse seine", "purse-seine", gear))

# Settype
t2ce_school  <- t2ce_school %>% 
  mutate(settype = gsub("FSC", "free schools", settype))

# Effort units
t2ce_school  <- t2ce_school %>% 
  mutate(effort_units = gsub("Number of ", "", effort_units), 
         effort_units = gsub("made", "", effort_units), 
         effort_units = gsub("sets", "number of sets", effort_units)
         )

# Months and time periods
t2ce_school <- t2ce_school %>% 
  mutate(month = gsub(17, NA, month), 
         month = gsub(13, 1, month), 
         month = gsub(14, 4, month), 
         month = gsub(15, 7, month), 
         month = gsub(16, 10, month),
         month = as.numeric(month),
         time_period = tolower(time_period),
         time_period = gsub("month", "monthly", time_period), 
         time_period = gsub("trimester", "quarterly", time_period))

# Generate data
# Generate quarterly data (aggregates)
quart_agg <- t2ce_school %>% 
  filter(time_period == "monthly") %>%
  mutate(month = ceiling(month/3),
         month = ifelse(month == 1, 1, # fix so each quarter == first month of quarter
                        ifelse(month == 2, 4, 
                               ifelse(month == 3, 7, 10))),
         time_period = "quarterly", 
         was_generated = "yes") %>% 
  group_by_at(setdiff(names(t2ce_school), c("catch", "effort"))) %>%
  summarise(catch = sum(catch), 
            effort = sum(effort))

# Generate yearly data (aggregates)
yearly_agg <- t2ce_school %>% 
  filter(time_period == "monthly") %>%
  mutate(month = NA,
         time_period = "yearly", 
         was_generated = "yes") %>% 
  group_by_at(setdiff(names(t2ce_school), c("catch", "effort"))) %>%
  summarise(catch = sum(catch), 
            effort = sum(effort))

# Combine raw with generated data
t2ce_school <- t2ce_school %>% 
  bind_rows(quart_agg) %>% 
  bind_rows(yearly_agg)

# Save File
filename <- "t2ce_by_school.csv"
write.csv(t2ce_school, paste0(save_location, filename), row.names = FALSE)

# Clean up
remove(t2ce_school, yearly_agg, quart_agg)
```
[Back To Top](#top)

# CDIS Data
```{r, echo=TRUE}
# Only keep data from year 2000 plus
cdis <- cdis %>% 
  filter(YearC >= 2000)

# Merge with other data
cdis <- cdis %>% 
  left_join(species[,c("SpeciesCode", "ScieName", "English")], by="SpeciesCode") %>% 
  left_join(gear_groups, by=c("GearGrp" = "Code"))

# Create relevant columns
cdis <- cdis %>% 
  mutate(rfmo = "ICCAT", 
         year = YearC, 
         month = Trimester,
         time_period = "quarterly", 
         country = FlagName, 
         gear = Name, 
         settype = SchoolType, 
         longitude = xLon5ctoid, 
         latitude = yLat5ctoid, 
         effort = NA, 
         effort_units = NA, 
         species_commonname = toupper(English), 
         species_sciname = toupper(ScieName), 
         is_targeted = ifelse(grepl("TUNA", species_commonname), "yes-implied", "no"),
         catch = Catch_t, 
         catch_units = "metric tonnes", 
         measurement = NA, 
         measurement_unit = NA, 
         measurement_method = NA, 
         spatial_notes = "center of 5x5 cell", 
         quality_code = NA, 
         was_generated = "no", 
         sources = NA)

# Keep only relevant columns
cdis <- cdis[,c("rfmo", "year", "month", "time_period", "country", "gear", "settype", "longitude", "latitude", "effort", "effort_units", "species_commonname", "species_sciname", "is_targeted", "catch", "catch_units", "measurement", "measurement_unit", "measurement_method", "spatial_notes", "quality_code", "was_generated", "sources")]

# Clean data
# Month
cdis <- cdis %>% 
  mutate(month = gsub(4, 10, month), 
         month = gsub(3, 7, month), 
         month = gsub(2, 4, month))

# Country
cdis <- cdis %>% 
  mutate(country = gsub("EU[.]|UK|PR|FR[.]|[.]", "", country), 
         country = gsub("USA", "United States", country), 
         country = gsub("Korea Rep", "Korea", country), 
         country = str_trim(country, side="both"))

# Gear
cdis <- cdis %>% 
  mutate(gear = gsub("purse seine", "purse-seine", gear), 
         gear = gsub("rood & reel", "rod-and-reel", gear))

# Settype
cdis <- cdis %>% 
  mutate(settype = gsub("n/a", NA, settype), 
         settype = gsub("FSC", "free school", settype))

# Generate data
# Generate yearly data (aggregates)
yearly_agg <- cdis %>% 
  mutate(month = NA,
         time_period = "yearly", 
         was_generated = "yes") %>% 
  group_by_at(setdiff(names(cdis), c("catch", "effort"))) %>%
  summarise(catch = sum(catch), 
            effort = sum(effort))

# Combine raw with generated data
cdis <- cdis %>%  
  bind_rows(yearly_agg)

# Save File
filename <- "cdis.csv"
write.csv(cdis, paste0(save_location, filename), row.names = FALSE)

# Clean up
remove(cdis, yearly_agg)
```
[Back To Top](#top)

# T2 Size Data
```{r, echo=TRUE}
size <- size_t2szStrata %>% 
  left_join(size_t2szProcs, by="InProcID") %>% 
  left_join(size_t2szFreqs, by="StrataID") %>% 
  left_join(size_Species, by="SpeciesCod")

remove(size, size_Species, size_t2szFreqs, size_t2szProcs, size_t2szStrata)
```
There's lots of different data here, but no metadata to describe what each column means. Not really useful without the metadata, but worth noting to come back later, if possible.

# Nominal Catch Data
It doesn't seem like this would be useful to us, because we can't get lat/lon coordinates from this dataset.

[Back To Top](#top)

# New Data
Found new bycatch data May 2020. 
```{r, echo=TRUE}
# Get list of new data
bycatch_list <- list.files(file_path, pattern = "ICCAT_")

# Read in the files
for(file in bycatch_list){ 
  temp <- read_excel(paste0(file_path, file))
  name <- colsplit(file, "[.]", c("",""))[,1]
  name <- paste(colsplit(name, "_", c("", ""))[,2]) 
  assign(name, temp)
}

# Clean up
remove(temp)

# Add Flag Codes
flag_codes <- read_xlsx(paste0(file_path, "CODES_Flags-Fleets.xlsx"), skip=3)
flag_codes <- flag_codes %>% 
  filter(!is.na(FlagCode)) %>% 
  select(FlagCode, FlagName)

# Add ASFIS Species
species_codes <- read_xlsx(paste0(file_path, "ASFIS_sp_2020.xlsx")) 
species_codes <- species_codes %>% 
  select(Scientific_name, English_name)
```

## Birds
```{r, echo=TRUE}
# Fix effort/catch units spread across different columns
birds <- birds %>% 
  pivot_longer(cols=TripsObsvd:`D@Sobsvd`, names_to = "effort_units", values_to = "effort")

# Fix catch units
birds <- birds %>% 
  mutate(MeasName = gsub("Fishing: Catch: number, total", "count", MeasName), 
         MeasName = gsub("Fishing: Catch: Presence-absence", 
                         "presence-absence", MeasName), 
         MeasName = gsub("Fishing: Catch: alive alongside", 
                         "count (alive)", MeasName), 
         MeasName = gsub("Fishing: Catch: per unit effort, unstandardized",
                         "CPUE (unstandardized)", MeasName), 
         MeasName = gsub("Fishing: Catch: per unit effort, standardized", 
                         "CPUE (standardized)", MeasName), 
         MeasName = gsub("Fishing: Discards", "count (discards)", MeasName)) %>% 
  mutate(Units = ifelse(is.na(Units) | Units == "no unit", MeasName, Units)) %>% 
  mutate(Units = gsub("N", "count", Units), 
         Units = gsub("/", " per ", Units), 
         Units = gsub("%", "percent", Units), 
         Units = gsub("hks", "hooks", Units), 
         Units = gsub("yr", "year", Units)) %>% 
  mutate(Alive = gsub("N", "(dead)", Alive), 
         Alive = gsub("Y", "(live)", Alive)) %>% 
  mutate(Units = ifelse(!is.na(Alive), paste(Units, Alive), Units))

# Fix effort units
birds <- birds %>% 
  mutate(effort_units = gsub("TripsObsvd", "trips", effort_units), 
         effort_units = gsub("SetsObsvd", "number of sets", effort_units), 
         effort_units = gsub("D@Sobsvd", "days at sea", effort_units), 
         effort_units = ifelse(is.na(effort), NA, effort_units))

# Fix gear types
birds <- birds %>% 
  mutate(GearGrp = gsub("LL", "longline", GearGrp), 
         GearGrp = gsub("VS", "vessel-associated school", GearGrp))

# Fix time periods; only keep data from the 1800s onwards
birds <- birds %>% 
  mutate(duration = (EndDate - StartDate) + 1, 
         time_period = ifelse(duration == 1, "yearly", paste0(duration, " years"))) %>% 
  filter(StartDate >= 1800 & EndDate > 2000)

# Fix source of data (will require adding new column to all datasets)
birds <- birds %>% 
  mutate(ObsvrsUsed = ifelse(ObsvrsUsed == TRUE, "observers", NA), 
         LogBksUsed = ifelse(LogBksUsed == TRUE, "logbooks", NA), 
         InterviewsUsed = ifelse(InterviewsUsed == TRUE, "interviews", NA), 
         LandingsUsed = ifelse(LandingsUsed == TRUE, "landings", NA), 
         PortSampUsed = ifelse(PortSampUsed == TRUE, "port sampling", NA), 
         FisheryIndep = ifelse(FisheryIndep == TRUE, "fishery-independent", NA)) %>%
  unite("sources", ObsvrsUsed:FisheryIndep, sep=", ", remove=TRUE, na.rm=TRUE) %>% 
  mutate(sources = gsub(", NA", "", sources), 
         sources = gsub("NA, ", "", sources), 
         sources = gsub("NA", NA, sources))

# Fix flags
birds <- birds %>% 
  left_join(flag_codes, by=c("Flag" = "FlagCode")) %>% 
  mutate(FlagName = gsub("Unclassified flag", NA, FlagName))

# Fix coordinates
birds <- birds %>% 
  mutate(latitude = (NorthLat+SouthLat)/2, 
         longitude = (EastLong+WestLong)/2, 
         spatial_notes = paste0("center of ", abs(EastLong-WestLong), "x", 
                                abs(NorthLat-SouthLat), " cell")) %>% 
  filter(latitude < 90 & latitude > -90 & longitude < 180 & longitude > -180)

# Fix species
birds <- birds %>% 
  left_join(species_codes, by=c("SciName" = "Scientific_name"))

birds <- birds %>% 
  mutate(English_name = ifelse(is.na(English_name), SciName, English_name)) %>% 
  mutate(English_name = gsub("Puffinus yelkoan", "yelkouan shearwater",
                             English_name), 
         English_name = gsub("Diomedea melanophrys", "black-browed albatross",
                             English_name), 
         English_name = gsub("Diomedea chlororhynchos", 
                             "atlantic yellow-nosed albatross", English_name), 
         English_name = gsub("Diomedea spp.", "great albatross",
                             English_name), 
         English_name = gsub(" group", "", English_name))

# Create relevant columns
birds <- birds %>% 
  mutate(rfmo = "ICCAT", 
         year = StartDate, 
         month = NA, 
         country = FlagName, 
         gear = GearGrp, 
         settype = ifelse(GearGrp == "vessel-associated school", 
                          "associated schools", NA),
         is_targeted = "no",
         catch = ObsvdValue, 
         catch_units = Units,
         species_commonname = toupper(English_name), 
         species_sciname = toupper(SciName),
         measurement = NA, 
         measurement_unit = NA, 
         measurement_method = NA, 
         quality_code = NA, 
         was_generated = "no", 
         sources = ifelse(sources == "", NA, sources))

# Keep only relevant columns
birds <- birds[,c("rfmo", "year", "month", "time_period", "country", "gear", "settype", "longitude", "latitude", "effort", "effort_units", "species_commonname", "species_sciname", "is_targeted", "catch", "catch_units", "measurement", "measurement_unit", "measurement_method", "spatial_notes", "quality_code", "was_generated", "sources")]

# Remove duplicates that were introduced when there were NAs for 2+ effort units
birds <- birds %>% 
  distinct_all() 

na_birds <- birds %>% 
  filter(is.na(effort) & is.na(effort_units))

birds <- birds %>% 
  filter(!is.na(effort) & !is.na(effort_units))

na_birds <- na_birds %>% 
  filter((!catch %in% birds$catch) & (!species_commonname %in% birds$species_commonname)) 

birds <- birds %>% 
  bind_rows(na_birds)

# Save File
filename <- "bycatch-birds.csv"
write.csv(birds, paste0(save_location, filename), row.names = FALSE)

# Clean up
remove(birds, na_birds)
```
[Back To Top](#top)

## Inverts
There's only one value so I'm just going to do it by hand
Update: It is outside of the proper bounds for lat/lon
```{r, echo=TRUE}
# Fix coordinates
inverts <- inverts %>% 
  mutate(latitude = (NorthLat+SouthLat)/2, 
         longitude = (EastLong+WestLong)/2, 
         spatial_notes = paste0("center of ", abs(EastLong-WestLong), "x", 
                                abs(NorthLat-SouthLat), " cell"))  %>% 
  filter(latitude < 90 & latitude > -90 & longitude < 180 & longitude > -180)

## Fix species
#inverts <- inverts %>% 
#  left_join(species_codes, by=c("SciName" = "Scientific_name"))
#
## Create relevant columns
#inverts <- inverts %>% 
#  mutate(rfmo = "ICCAT", 
#         year = StartDate, 
#         month = NA, 
#         time_period = paste((EndDate - StartDate) + 1, " years"), 
#         country = NA, 
#         gear = "purse-seine", 
#         settype = NA,
#         is_targeted = "no",
#         catch = ObsvdValue, 
#         catch_units = "metric tonnes",
#         effort = NA, 
#         effort_units = NA,
#         species_commonname = toupper(English_name), 
#         species_sciname = toupper(SciName),
#         measurement = NA, 
#         measurement_unit = NA, 
#         measurement_method = NA, 
#         quality_code = NA, 
#         was_generated = "no", 
#         sources = NA)
#
## Keep only relevant columns
#inverts <- inverts[,c("rfmo", "year", "month", "time_period", "country", "gear", "settype", "longitude", #"latitude", "effort", "effort_units", "species_commonname", "species_sciname", "is_targeted", "catch", #"catch_units", "measurement", "measurement_unit", "measurement_method", "spatial_notes", "quality_code", #"was_generated", "sources")]
#
## Save File
#filename <- "bycatch-inverts.csv"
#save_location <- "/Volumes/GoogleDrive/Shared #drives/emlab/projects/current-projects/blue-prosperity-coalition/broader-research/mpa-bycatch/data/rfmo-review/edited/"
#new_folder <- "iccat/"
#write.csv(inverts, paste0(save_location, new_folder, filename), row.names = FALSE)

# Clean up
remove(inverts, na_inverts)
```
[Back To Top](#top)

## Marine Mammals
```{r, echo=TRUE}
# Fix effort/catch units spread across different columns
marinemammals <- marinemammals %>% 
  pivot_longer(cols=TripsObsvd:`D@Sobsvd`, names_to = "effort_units", values_to = "effort")

# Fix catch units
marinemammals <- marinemammals %>% 
  mutate(MeasName = gsub("Fishing: Catch: number, total", "count", MeasName), 
         MeasName = gsub("Fishing: Catch: Presence-absence", 
                         "presence-absence", MeasName), 
         MeasName = gsub("Fishing: Catch: alive alongside", 
                         "count (alive)", MeasName), 
         MeasName = gsub("Fishing: Catch: per unit effort, unstandardized",
                         "CPUE (unstandardized)", MeasName), 
         MeasName = gsub("Fishing: Catch: per unit effort, standardized", 
                         "CPUE (standardized)", MeasName), 
         MeasName = gsub("Fishing: Discards", "count (discards)", MeasName), 
         MeasName = gsub("Fishing: Discards, survival of", "count (discards survived)", MeasName),
         MeasName = gsub("Fishing: Catch: weight, total", "weight", MeasName)
         ) %>% 
  mutate(Units = ifelse(is.na(Units) | Units == "no unit", MeasName, Units)) %>% 
  mutate(Units = gsub("N", "count", Units), 
         Units = gsub("/", " per ", Units), 
         Units = gsub("%", "percent", Units), 
         Units = gsub("hks", "hooks", Units), 
         Units = gsub("yr", "year", Units), 
         ObsvdValue = ifelse(Units == "kg", ObsvdValue/1000, ObsvdValue), 
         Units = ifelse(Units == "kg", "metric tonnes", Units)) %>% 
  mutate(Alive = gsub("N", "(dead)", Alive), 
         Alive = gsub("Y", "(live)", Alive)) %>% 
  mutate(Units = ifelse(!is.na(Alive), paste(Units, Alive), Units))

# Fix effort units
marinemammals <- marinemammals %>% 
  mutate(effort_units = gsub("TripsObsvd", "trips", effort_units), 
         effort_units = gsub("SetsObsvd", "number of sets", effort_units), 
         effort_units = gsub("D@Sobsvd", "days at sea", effort_units), 
         effort_units = ifelse(is.na(effort), NA, effort_units))

# Fix gear types
marinemammals <- marinemammals %>% 
  mutate(GearGrp = gsub("LL", "longline", GearGrp), 
         GearGrp = gsub("VS", "vessel-associated school", GearGrp), 
         GearGrp = gsub("PS", "purse-seine", GearGrp), 
         GearGrp = gsub("GN", "gillnet", GearGrp)
         )

# Fix time periods; only keep data from the 1800s onwards
marinemammals <- marinemammals %>% 
  mutate(duration = (EndDate - StartDate) + 1, 
         time_period = ifelse(duration == 1, "yearly", paste0(duration, " years"))) %>% 
  filter(StartDate >= 1800 & EndDate > 2000)

# Fix source of data (will require adding new column to all datasets)
marinemammals <- marinemammals %>% 
  mutate(ObsvrsUsed = ifelse(ObsvrsUsed == TRUE, "observers", NA), 
         LogBksUsed = ifelse(LogBksUsed == TRUE, "logbooks", NA), 
         InterviewsUsed = ifelse(InterviewsUsed == TRUE, "interviews", NA), 
         LandingsUsed = ifelse(LandingsUsed == TRUE, "landings", NA), 
         PortSampUsed = ifelse(PortSampUsed == TRUE, "port sampling", NA), 
         FisheryIndep = ifelse(FisheryIndep == TRUE, "fishery-independent", NA)) %>%
  unite("sources", ObsvrsUsed:FisheryIndep, sep=", ", remove=TRUE, na.rm=TRUE) %>% 
  mutate(sources = gsub(", NA", "", sources), 
         sources = gsub("NA, ", "", sources), 
         sources = gsub("NA", NA, sources))

# Fix flags
marinemammals <- marinemammals %>% 
  left_join(flag_codes, by=c("Flag" = "FlagCode")) %>% 
  mutate(FlagName = gsub("Unclassified flag", NA, FlagName))

# Fix coordinates
marinemammals <- marinemammals %>% 
  mutate(latitude = (NorthLat+SouthLat)/2, 
         longitude = (EastLong+WestLong)/2, 
         spatial_notes = paste0("center of ", abs(EastLong-WestLong), "x", 
                                abs(NorthLat-SouthLat), " cell")) %>% 
  filter(latitude < 90 & latitude > -90 & longitude < 180 & longitude > -180)

# Fix species
marinemammals <- marinemammals %>% 
  left_join(species_codes, by=c("SciName" = "Scientific_name"))

marinemammals <- marinemammals %>% 
  mutate(English_name = ifelse(is.na(English_name), SciName, English_name)) %>% 
  mutate(English_name = gsub("Arctocephalus sp." , "fur seals",
                             English_name), 
         English_name = gsub("Delphininae" , "oceanic dolphins nei",
                             English_name), 
         English_name = gsub("Mesoplodon sp.", "mesoplodont whales",
                             English_name), 
         English_name = gsub("Pagophilus groenlandicus", 
                             "harp seal", English_name), 
         English_name = gsub("Cetacea", "cetaceans",
                             English_name), 
         English_name = gsub(" group", "", English_name))

# Create relevant columns
marinemammals <- marinemammals %>% 
  mutate(rfmo = "ICCAT", 
         year = as.numeric(as.integer(StartDate)), 
         month = NA, 
         country = FlagName, 
         gear = GearGrp, 
         settype = ifelse(GearGrp == "vessel-associated school", 
                          "associated schools", NA),
         is_targeted = "no",
         catch = ObsvdValue, 
         catch_units = Units,
         species_commonname = toupper(English_name), 
         species_sciname = toupper(SciName),
         measurement = NA, 
         measurement_unit = NA, 
         measurement_method = NA, 
         quality_code = NA, 
         was_generated = "no", 
         sources = ifelse(sources == "", NA, sources))

# Keep only relevant columns
marinemammals <- marinemammals[,c("rfmo", "year", "month", "time_period", "country", "gear", "settype", "longitude", "latitude", "effort", "effort_units", "species_commonname", "species_sciname", "is_targeted", "catch", "catch_units", "measurement", "measurement_unit", "measurement_method", "spatial_notes", "quality_code", "was_generated", "sources")]

# Remove duplicates that were introduced when there were NAs for 2+ effort units
marinemammals <- marinemammals %>% 
  distinct_all() 

na_marinemammals <- marinemammals %>% 
  filter(is.na(effort) & is.na(effort_units))

marinemammals <- marinemammals %>% 
  filter(!is.na(effort) & !is.na(effort_units))

na_marinemammals <- na_marinemammals %>% 
  filter((!catch %in% marinemammals$catch) & (!species_commonname %in% marinemammals$species_commonname)) 

marinemammals <- marinemammals %>% 
  bind_rows(na_marinemammals)

# Save File
filename <- "bycatch-marinemammals.csv"
write.csv(marinemammals, paste0(save_location, filename), row.names = FALSE)

# Clean up
remove(marinemammals, na_marinemammals)
```
[Back To Top](#top)

## Sharks
```{r, echo=TRUE}
# Fix effort/catch units spread across different columns
sharks <- sharks %>% 
  pivot_longer(cols=TripsObsvd:`D@Sobsvd`, names_to = "effort_units", values_to = "effort")

# Fix catch units
sharks <- sharks %>% 
  mutate(MeasName = gsub("Fishing: Catch: number, total", "count", MeasName), 
         MeasName = gsub("Fishing: Catch: Presence-absence", 
                         "presence-absence", MeasName), 
         MeasName = gsub("Fishing: Catch: alive alongside", 
                         "count (alive)", MeasName), 
         MeasName = gsub("Fishing: Catch: per unit effort, unstandardized",
                         "CPUE (unstandardized)", MeasName), 
         MeasName = gsub("Fishing: Catch: per unit effort, standardized", 
                         "CPUE (standardized)", MeasName), 
         MeasName = gsub("Fishing: Discards", "count (discards)", MeasName), 
         MeasName = gsub("Fishing: Discards, survival of", 
                         "count (discards survived)", MeasName),
         MeasName = gsub("Fishing: Catch: weight, total", "weight", MeasName), 
         MeasName = gsub("Fishing: Catch: occurrence, free school", 
                         "free school", MeasName), 
         MeasName = gsub("Fishing: Catch: occurrence, FAD", 
                         "FAD", MeasName), 
         MeasName = gsub("Fishing: Catch: positive trips", 
                         "positive trips", MeasName)
         ) %>% 
  mutate(Units = ifelse(is.na(Units) | Units == "no unit", MeasName, Units)) %>% 
  mutate(Units = gsub("N", "count", Units), 
         Units = gsub("/", " per ", Units), 
         Units = gsub("%", "percent", Units), 
         Units = gsub("hks", "hooks", Units), 
         Units = gsub("yr", "year", Units), 
         ObsvdValue = ifelse(Units == "kg", ObsvdValue/1000, ObsvdValue), 
         Units = ifelse(Units == "kg", "metric tonnes", Units), 
         Units = ifelse(Units == "t", "metric tonnes", Units)) %>% 
  mutate(Alive = gsub("N", "(dead)", Alive), 
         Alive = gsub("Y", "(live)", Alive)) %>% 
  mutate(Units = ifelse(!is.na(Alive), paste(Units, Alive), Units))

# Fix effort units
sharks <- sharks %>% 
  mutate(effort_units = gsub("TripsObsvd", "trips", effort_units), 
         effort_units = gsub("SetsObsvd", "number of sets", effort_units), 
         effort_units = gsub("D@Sobsvd", "days at sea", effort_units), 
         effort_units = ifelse(is.na(effort), NA, effort_units))

# Fix gear types
sharks <- sharks %>% 
  left_join(gear_groups, by=c("GearGrp" = "Code")) %>% 
  mutate(gear = Name) %>% 
  mutate(gear = gsub("purse seine", "purse-seine", gear), 
         gear = gsub("rood & reel", "rod-and-reel", gear),
         gear = gsub("unclassified", NA, gear), 
         gear = gsub("Unclassified (surface)", "surface gear", gear),
         gear = gsub("trammerl net", "trammel net", gear), 
         gear = ifelse(is.na(gear) & GearGrp == "VS", 
                       "vessel-associated school", gear))

# Fix time periods; only keep data from the 1800s onwards
sharks <- sharks %>% 
  mutate(duration = (EndDate - StartDate) + 1, 
         time_period = ifelse(duration == 1, "yearly", paste0(duration, " years"))) %>% 
  filter(StartDate >= 1800 & EndDate > 2000)

# Fix source of data (will require adding new column to all datasets)
sharks <- sharks %>% 
  mutate(ObsvrsUsed = ifelse(ObsvrsUsed == TRUE, "observers", NA), 
         LogBksUsed = ifelse(LogBksUsed == TRUE, "logbooks", NA), 
         InterviewsUsed = ifelse(InterviewsUsed == TRUE, "interviews", NA), 
         LandingsUsed = ifelse(LandingsUsed == TRUE, "landings", NA), 
         PortSampUsed = ifelse(PortSampUsed == TRUE, "port sampling", NA), 
         FisheryIndep = ifelse(FisheryIndep == TRUE, "fishery-independent", NA)) %>%
  unite("sources", ObsvrsUsed:FisheryIndep, sep=", ", remove=TRUE, na.rm=TRUE) %>% 
  mutate(sources = gsub(", NA", "", sources), 
         sources = gsub("NA, ", "", sources), 
         sources = gsub("NA", NA, sources))

# Fix flags
sharks <- sharks %>% 
  left_join(flag_codes, by=c("Flag" = "FlagCode")) %>% 
  mutate(FlagName = gsub("Unclassified flag", NA, FlagName))

# Fix coordinates
sharks <- sharks %>% 
  mutate(latitude = (NorthLat+SouthLat)/2, 
         longitude = (EastLong+WestLong)/2, 
         spatial_notes = paste0("center of ", abs(EastLong-WestLong), "x", 
                                abs(NorthLat-SouthLat), " cell"))  %>% 
  filter(latitude < 90 & latitude > -90 & longitude < 180 & longitude > -180)

# Fix species
sharks <- sharks %>% 
  left_join(species_codes, by=c("SciName" = "Scientific_name"))

sharks <- sharks %>% 
  mutate(English_name = ifelse(is.na(English_name), SciName, English_name)) %>% 
  mutate(English_name = gsub("Rhincodion typus" , "whale shark",
                             English_name), 
         English_name = gsub("Zameus squamulosus" , "velvet dogfish",
                             English_name), 
         English_name = gsub("Alopias sp.", "thresher sharks nei",
                             English_name),  
         English_name = gsub("Sphyrna sp.", "hammerhead shark nei",
                             English_name), 
         English_name = gsub("Elasmobranch group", "elasmobranch nei", English_name))

# Create relevant columns
sharks <- sharks %>% 
  mutate(rfmo = "ICCAT", 
         year = as.numeric(as.integer(StartDate)), 
         month = NA, 
         country = FlagName,  
         settype = ifelse(MeasName == "FAD|free school", MeasName, 
                          ifelse(gear == "vessel-associated school", 
                                 "associated schools", NA)),
         is_targeted = "no",
         catch = ObsvdValue, 
         catch_units = Units,
         species_commonname = toupper(English_name), 
         species_sciname = toupper(SciName),
         measurement = NA, 
         measurement_unit = NA, 
         measurement_method = NA, 
         quality_code = NA, 
         was_generated = "no", 
         sources = ifelse(sources == "", NA, sources))

# Keep only relevant columns
sharks <- sharks[,c("rfmo", "year", "month", "time_period", "country", "gear", "settype", "longitude", "latitude", "effort", "effort_units", "species_commonname", "species_sciname", "is_targeted", "catch", "catch_units", "measurement", "measurement_unit", "measurement_method", "spatial_notes", "quality_code", "was_generated", "sources")]

# Remove duplicates that were introduced when there were NAs for 2+ effort units
sharks <- sharks %>% 
  distinct_all() 

na_sharks <- sharks %>% 
  filter(is.na(effort) & is.na(effort_units))

sharks <- sharks %>% 
  filter(!is.na(effort) & !is.na(effort_units))

na_sharks <- na_sharks %>% 
  filter((!catch %in% sharks$catch) & (!species_commonname %in% sharks$species_commonname)) 

sharks <- sharks %>% 
  bind_rows(na_sharks)

# Save File
filename <- "bycatch-sharks.csv"
write.csv(sharks, paste0(save_location, filename), row.names = FALSE)

# Clean up
remove(sharks, na_sharks)
```
[Back To Top](#top)

## Teleosts
```{r, echo=TRUE}
# Fix effort/catch units spread across different columns
teleosts <- teleosts %>% 
  pivot_longer(cols=TripsObsvd:`D@Sobsvd`, names_to = "effort_units", values_to = "effort")

# Fix catch units
teleosts <- teleosts %>% 
  mutate(MeasName = gsub("Fishing: Catch: number, total", "count", MeasName), 
         MeasName = gsub("Fishing: Catch: Presence-absence", 
                         "presence-absence", MeasName), 
         MeasName = gsub("Fishing: Catch: alive alongside", 
                         "count (alive)", MeasName), 
         MeasName = gsub("Fishing: Catch: per unit effort, unstandardized",
                         "CPUE (unstandardized)", MeasName), 
         MeasName = gsub("Fishing: Catch: per unit effort, standardized", 
                         "CPUE (standardized)", MeasName), 
         MeasName = gsub("Fishing: Discards, survival of", 
                         "count (discards survived)", MeasName),
         MeasName = gsub("Fishing: Discards", "count (discards)", MeasName), 
         MeasName = gsub("Fishing: Catch: weight, total", "weight", MeasName), 
         MeasName = gsub("Fishing: Catch: occurrence, free school", 
                         "free school", MeasName), 
         MeasName = gsub("Fishing: Catch: occurrence, FAD", 
                         "FAD", MeasName), 
         MeasName = gsub("Fishing: Catch: positive trips", 
                         "positive trips", MeasName), 
         MeasName = gsub("Geographic: sighted", 
                         "count (sighted)", MeasName)
         ) %>% 
  mutate(Units = ifelse(is.na(Units) | Units == "no unit", MeasName, Units)) %>% 
  mutate(Units = gsub("N", "count", Units), 
         Units = gsub("/", " per ", Units), 
         Units = gsub("%", "percent", Units), 
         Units = gsub("hks", "hooks", Units), 
         Units = gsub("yr", "year", Units), 
         ObsvdValue = ifelse(Units == "kg", ObsvdValue/1000, ObsvdValue), 
         Units = ifelse(Units == "kg", "metric tonnes", Units), 
         Units = ifelse(Units == "t", "metric tonnes", Units)) %>% 
  mutate(Alive = gsub("N", "(dead)", Alive), 
         Alive = gsub("Y", "(live)", Alive)) %>% 
  mutate(Units = ifelse(!is.na(Alive), paste(Units, Alive), Units))

# Fix for if there are weights/lengths
teleosts <- teleosts %>% 
  mutate(measurement = ifelse(grepl("Length", MeasName), ObsvdValue, NA), 
         measurement_unit = ifelse(grepl("Length", MeasName), Units, NA), 
         measurement_method = ifelse(grepl("pre-anal fin", MeasName), 
                                    "pre-anal fin length", NA), 
         catch = ifelse(grepl("Length", MeasName), Nfish, ObsvdValue), 
         catch_units = ifelse(grepl("Length", MeasName), "count", Units)) %>% 
  mutate(measurement_method = ifelse(measurement_unit == "cm y", 
                                     "live measurement", NA), 
         measurement_method = ifelse(measurement_unit == "cm n", 
                                     "dead measurement", NA), 
         measurement_unit = gsub("cm y|cm n", "cm", measurement_unit))

# Fix effort units
teleosts <- teleosts %>% 
  mutate(effort_units = gsub("TripsObsvd", "trips", effort_units), 
         effort_units = gsub("SetsObsvd", "number of sets", effort_units), 
         effort_units = gsub("D@Sobsvd", "days at sea", effort_units), 
         effort_units = ifelse(is.na(effort), NA, effort_units))

# Fix gear types
teleosts <- teleosts %>% 
  left_join(gear_groups, by=c("GearGrp" = "Code")) %>% 
  mutate(gear = Name) %>% 
  mutate(gear = gsub("purse seine", "purse-seine", gear), 
         gear = gsub("unclassified", NA, gear), 
         gear = gsub("Unclassified (surface)", "surface gear", gear),
         gear = ifelse(is.na(gear) & GearGrp == "VS", 
                       "vessel-associated school", gear))

# Fix time periods; only keep data from the 1800s onwards
teleosts <- teleosts %>% 
  mutate(duration = (EndDate - StartDate) + 1, 
         time_period = ifelse(duration == 1, "yearly", paste0(duration, " years"))) %>% 
  filter(StartDate >= 1800 & EndDate > 2000)

# Fix source of data (will require adding new column to all datasets)
teleosts <- teleosts %>% 
  mutate(ObsvrsUsed = ifelse(ObsvrsUsed == TRUE, "observers", NA), 
         LogBksUsed = ifelse(LogBksUsed == TRUE, "logbooks", NA), 
         InterviewsUsed = ifelse(InterviewsUsed == TRUE, "interviews", NA), 
         LandingsUsed = ifelse(LandingsUsed == TRUE, "landings", NA), 
         PortSampUsed = ifelse(PortSampUsed == TRUE, "port sampling", NA), 
         FisheryIndep = ifelse(FisheryIndep == TRUE, "fishery-independent", NA)) %>%
  unite("sources", ObsvrsUsed:FisheryIndep, sep=", ", remove=TRUE, na.rm=TRUE) %>% 
  mutate(sources = gsub(", NA", "", sources), 
         sources = gsub("NA, ", "", sources), 
         sources = gsub("NA", NA, sources))

# Fix flags
teleosts <- teleosts %>% 
  left_join(flag_codes, by=c("Flag" = "FlagCode")) %>% 
  mutate(FlagName = gsub("Unclassified flag", NA, FlagName))

# Fix coordinates
teleosts <- teleosts %>% 
  mutate(latitude = (NorthLat+SouthLat)/2, 
         longitude = (EastLong+WestLong)/2, 
         spatial_notes = paste0("center of ", abs(EastLong-WestLong), "x", 
                                abs(NorthLat-SouthLat), " cell"))  %>% 
  filter(latitude < 90 & latitude > -90 & longitude < 180 & longitude > -180)

# Fix species
teleosts <- teleosts %>% 
  left_join(species_codes, by=c("SciName" = "Scientific_name"))

teleosts <- teleosts %>% 
  mutate(English_name = ifelse(is.na(English_name), SciName, English_name)) %>% 
  mutate(SciName = gsub("Kyphosus sectator", "Kyphosus sectatrix", SciName),
         English_name = gsub("Kyphosus sectator" , "bermuda sea chub",
                             English_name), 
         English_name = gsub("Balistes capriscus" , "gray triggerfish",
                             English_name), 
         English_name = gsub("Kyphosus sp.", "sea chub nei",
                             English_name),  
         English_name = gsub("Labotes surinamensis", "atlantic stripetail",
                             English_name), 
         English_name = gsub("Canthidermis maculatus", "rough triggerfish",
                             English_name),
         English_name = gsub("Abalistes stellatus", "starry triggerfish",
                             English_name), 
         English_name = gsub("Alephisaurus spp", "lancetfish nei",
                             English_name), 
         English_name = gsub("Cubiceps sp.", "cubiceps nei",
                             English_name), 
         SciName = gsub("Seriola dumerilii", "Seriola dumerili", SciName),
         English_name = gsub("Seriola dumerilii", "greater amberjack",
                             English_name), 
         SciName = gsub("Alutera punctata", "Aluterus schoepfii ", SciName),
         English_name = gsub("Alutera punctata", "orange filefish",
                             English_name), 
         English_name = gsub("Taractes rubescens", "pomfret",
                             English_name),
         SciName = gsub("Scomber scobrus", "Scomber scombrus", SciName), 
         English_name = gsub("Scomber scobrus", "atlantic mackerel",
                             English_name), 
         English_name = gsub("Mola sp.", "mola nei", English_name))

# Create relevant columns
teleosts <- teleosts %>% 
  mutate(rfmo = "ICCAT", 
         year = as.numeric(as.integer(StartDate)), 
         month = NA, 
         country = FlagName,  
         settype = ifelse(MeasName == "FAD|free school", MeasName, 
                          ifelse(gear == "vessel-associated school", 
                                 "associated schools", NA)),
         is_targeted = "no",
         species_commonname = toupper(English_name), 
         species_sciname = toupper(SciName),
         quality_code = NA, 
         was_generated = "no", 
         sources = ifelse(sources == "", NA, sources))

# Keep only relevant columns
teleosts <- teleosts[,c("rfmo", "year", "month", "time_period", "country", "gear", "settype", "longitude", "latitude", "effort", "effort_units", "species_commonname", "species_sciname", "is_targeted", "catch", "catch_units", "measurement", "measurement_unit", "measurement_method", "spatial_notes", "quality_code", "was_generated", "sources")]

# Remove duplicates that were introduced when there were NAs for 2+ effort units
teleosts <- teleosts %>% 
  distinct_all() 

na_teleosts <- teleosts %>% 
  filter(is.na(effort) & is.na(effort_units))

teleosts <- teleosts %>% 
  filter(!is.na(effort) & !is.na(effort_units))

na_teleosts <- na_teleosts %>% 
  filter((!catch %in% teleosts$catch) & (!species_commonname %in% teleosts$species_commonname)) 

teleosts <- teleosts %>% 
  bind_rows(na_teleosts)

# Save File
filename <- "bycatch-teleosts.csv"
write.csv(teleosts, paste0(save_location, filename), row.names = FALSE)

# Clean up
remove(teleosts, na_teleosts)
```
[Back To Top](#top)

## Tunas 
```{r, echo=TRUE}
# Fix effort/catch units spread across different columns
tunas <- tunas %>% 
  pivot_longer(cols=TripsObsvd:`D@Sobsvd`, names_to = "effort_units", values_to = "effort")

# Fix catch units
tunas <- tunas %>% 
  mutate(MeasName = gsub("Fishing: Catch: number, total", "count", MeasName), 
         MeasName = gsub("Fishing: Catch: Presence-absence", 
                         "presence-absence", MeasName), 
         MeasName = gsub("Fishing: Catch: alive alongside", 
                         "count (alive)", MeasName), 
         MeasName = gsub("Fishing: Catch: per unit effort, unstandardized",
                         "CPUE (unstandardized)", MeasName), 
         MeasName = gsub("Fishing: Catch: per unit effort, standardized", 
                         "CPUE (standardized)", MeasName), 
         MeasName = gsub("Fishing: Discards, survival of", 
                         "count (discards survived)", MeasName),
         MeasName = gsub("Fishing: Discards", "count (discards)", MeasName), 
         MeasName = gsub("Fishing: Catch: weight, total", "weight", MeasName), 
         MeasName = gsub("Fishing: Catch: occurrence, free school", 
                         "free school", MeasName), 
         MeasName = gsub("Fishing: Catch: occurrence, FAD", 
                         "FAD", MeasName), 
         MeasName = gsub("Fishing: Catch: positive trips", 
                         "positive trips", MeasName), 
         MeasName = gsub("Geographic: sighted", 
                         "count (sighted)", MeasName), 
         MeasName = gsub("Fishing: Discard of juveniles", "count (discards; juvenile)", MeasName)
         ) %>% 
  mutate(Units = ifelse(is.na(Units) | Units == "no unit", MeasName, Units)) %>% 
  mutate(Units = gsub("N", "count", Units), 
         Units = gsub("/", " per ", Units), 
         Units = gsub("%", "percent", Units), 
         Units = gsub("hks", "hooks", Units), 
         Units = gsub("yr", "year", Units), 
         ObsvdValue = ifelse(Units == "kg", ObsvdValue/1000, ObsvdValue), 
         Units = ifelse(Units == "kg", "metric tonnes", Units), 
         Units = ifelse(Units == "t", "metric tonnes", Units)) %>% 
  mutate(Alive = gsub("N", "(dead)", Alive), 
         Alive = gsub("Y", "(live)", Alive)) %>% 
  mutate(Units = ifelse(!is.na(Alive), paste(Units, Alive), Units)) %>% 
  mutate(Units = gsub("count n", "count (dead)", Units), 
         Units = gsub("rel. unit", "relative units", Units), 
         Units = gsub("Wt", "weight", Units),
         Units = gsub("metric tonnes n", "metric tonnes (dead)", Units))

# Fix for if there are weights/lengths
# Deciding to remove all indices, coefficients, von Bert values, tag recapture, etc... 
tunas <- tunas %>% 
  filter(!grepl("allometric|index|spawned|von|mark|power|stomach", Units)) %>% 
  mutate(measurement = ifelse(grepl("Length", MeasName), ObsvdValue, NA), 
         measurement_unit = ifelse(grepl("Length", MeasName), Units, NA), 
         measurement_method = ifelse(grepl("pre-anal fin", MeasName), 
                                    "pre-anal fin length", NA), 
         catch = ifelse(grepl("Length", MeasName), Nfish, ObsvdValue), 
         catch_units = ifelse(grepl("Length", MeasName), "count", Units)) %>% 
  mutate(measurement_method = ifelse(measurement_unit == "cm y", 
                                     "live measurement", NA), 
         measurement_method = ifelse(measurement_unit == "cm n", 
                                     "dead measurement", NA), 
         measurement_unit = gsub("cm y|cm n", "cm", measurement_unit))

# Fix effort units
tunas <- tunas %>% 
  mutate(effort_units = gsub("TripsObsvd", "trips", effort_units), 
         effort_units = gsub("SetsObsvd", "number of sets", effort_units), 
         effort_units = gsub("D@Sobsvd", "days at sea", effort_units), 
         effort_units = ifelse(is.na(effort), NA, effort_units))

# Fix gear types
tunas <- tunas %>% 
  left_join(gear_groups, by=c("GearGrp" = "Code")) %>% 
  mutate(gear = Name) %>% 
  mutate(gear = gsub("purse seine", "purse-seine", gear), 
         gear = gsub("unclassified", NA, gear), 
         gear = gsub("Unclassified (surface)", "surface gear", gear),
         gear = ifelse(is.na(gear) & GearGrp == "VS", 
                       "vessel-associated school", gear), 
         gear = ifelse(is.na(gear) & GearGrp == "UN", 
                       "unassociated school", gear))

# Fix time periods; only keep data from the 1800s onwards
tunas <- tunas %>% 
  mutate(duration = (EndDate - StartDate) + 1, 
         time_period = ifelse(duration == 1, "yearly", paste0(duration, " years"))) %>% 
  filter(StartDate >= 1800 & EndDate > 2000)

# Fix source of data (will require adding new column to all datasets)
tunas <- tunas %>% 
  mutate(ObsvrsUsed = ifelse(ObsvrsUsed == TRUE, "observers", NA), 
         LogBksUsed = ifelse(LogBksUsed == TRUE, "logbooks", NA), 
         InterviewsUsed = ifelse(InterviewsUsed == TRUE, "interviews", NA), 
         LandingsUsed = ifelse(LandingsUsed == TRUE, "landings", NA), 
         PortSampUsed = ifelse(PortSampUsed == TRUE, "port sampling", NA), 
         FisheryIndep = ifelse(FisheryIndep == TRUE, "fishery-independent", NA)) %>%
  unite("sources", ObsvrsUsed:FisheryIndep, sep=", ", remove=TRUE, na.rm=TRUE) %>% 
  mutate(sources = gsub(", NA", "", sources), 
         sources = gsub("NA, ", "", sources), 
         sources = gsub("NA", NA, sources))

# Fix flags
tunas <- tunas %>%  
  left_join(flag_codes, by=c("Flag" = "FlagCode")) %>% 
  mutate(FlagName = gsub("Unclassified flag", NA, FlagName))

# Fix coordinates
tunas <- tunas %>% 
  mutate(latitude = (NorthLat+SouthLat)/2, 
         longitude = (EastLong+WestLong)/2, 
         spatial_notes = paste0("center of ", abs(EastLong-WestLong), "x", 
                                abs(NorthLat-SouthLat), " cell"))  %>% 
  filter(latitude < 90 & latitude > -90 & longitude < 180 & longitude > -180)

# Fix species
tunas <- tunas %>% 
  left_join(species_codes, by=c("SciName" = "Scientific_name"))

tunas <- tunas %>% 
  mutate(English_name = ifelse(is.na(English_name), SciName, English_name)) %>% 
  mutate(English_name = gsub("Makaira mazara" , "indo-pacific blue marlin",
                             English_name), 
         SciName = gsub("Tetrapturus georgei", "Tetrapturus georgii", SciName),
         English_name = gsub("Tetrapturus georgei" , "roundscale spearfish",
                             English_name))

# Create relevant columns
tunas <- tunas %>% 
  mutate(rfmo = "ICCAT", 
         year = as.numeric(as.integer(StartDate)), 
         month = NA, 
         country = FlagName,  
         settype = ifelse(MeasName == "FAD|free school", MeasName, 
                          ifelse(gear == "vessel-associated school", 
                                 "associated schools", 
                                 ifelse(gear == "unassociated school", 
                                        "unassociated schools", NA))),
         is_targeted = "no",
         species_commonname = toupper(English_name), 
         species_sciname = toupper(SciName),
         quality_code = NA, 
         was_generated = "no", 
         sources = ifelse(sources == "", NA, sources))

# Keep only relevant columns
tunas <- tunas[,c("rfmo", "year", "month", "time_period", "country", "gear", "settype", "longitude", "latitude", "effort", "effort_units", "species_commonname", "species_sciname", "is_targeted", "catch", "catch_units", "measurement", "measurement_unit", "measurement_method", "spatial_notes", "quality_code", "was_generated", "sources")]

# Remove duplicates that were introduced when there were NAs for 2+ effort units
tunas <- tunas %>% 
  distinct_all() 

na_tunas <- tunas %>% 
  filter(is.na(effort) & is.na(effort_units))

tunas <- tunas %>% 
  filter(!is.na(effort) & !is.na(effort_units))

na_tunas <- na_tunas %>% 
  filter((!catch %in% tunas$catch) & (!species_commonname %in% tunas$species_commonname)) 

tunas <- tunas %>% 
  bind_rows(na_tunas)

# Save File
filename <- "bycatch-tunas.csv"
write.csv(tunas, paste0(save_location, filename), row.names = FALSE)

# Clean up
remove(tunas, na_tunas)
```
[Back To Top](#top)

## Turtles
```{r, echo=TRUE}
# Fix effort/catch units spread across different columns
turtles <- turtles %>% 
  pivot_longer(cols=TripsObsvd:`D@Sobsvd`, names_to = "effort_units", values_to = "effort")

# Fix catch units
turtles <- turtles %>% 
  mutate(MeasName = gsub("Fishing: Catch: number, total", "count", MeasName), 
         MeasName = gsub("Fishing: Catch: Presence-absence", 
                         "presence-absence", MeasName), 
         MeasName = gsub("Fishing: Catch: alive alongside", 
                         "count (alive)", MeasName), 
         MeasName = gsub("Fishing: Catch: per unit effort, unstandardized",
                         "CPUE (unstandardized)", MeasName), 
         MeasName = gsub("Fishing: Catch: per unit effort, standardized", 
                         "CPUE (standardized)", MeasName), 
         MeasName = gsub("Fishing: Discards, survival of", 
                         "count (discards survived)", MeasName),
         MeasName = gsub("Fishing: Discards", "count (discards)", MeasName), 
         MeasName = gsub("Fishing: Catch: weight, total", "weight", MeasName), 
         MeasName = gsub("Fishing: Catch: occurrence, free school", 
                         "free school", MeasName), 
         MeasName = gsub("Fishing: Catch: occurrence, FAD", 
                         "FAD", MeasName), 
         MeasName = gsub("Fishing: Catch: positive trips", 
                         "positive trips", MeasName), 
         MeasName = gsub("Geographic: sighted", 
                         "count (sighted)", MeasName), 
         MeasName = gsub("Fishing: Discard of juveniles", "count (discards; juvenile)", MeasName)
         ) %>% 
  mutate(Units = ifelse(is.na(Units) | Units == "no unit", MeasName, Units)) %>% 
  mutate(Units = gsub("N", "count", Units), 
         Units = gsub("/", " per ", Units), 
         Units = gsub("%", "percent", Units), 
         Units = gsub("hks", "hooks", Units), 
         Units = gsub("yr", "year", Units), 
         ObsvdValue = ifelse(Units == "kg", ObsvdValue/1000, ObsvdValue), 
         Units = ifelse(Units == "kg", "metric tonnes", Units), 
         Units = ifelse(Units == "t", "metric tonnes", Units)) %>% 
  mutate(Alive = gsub("N", "(dead)", Alive), 
         Alive = gsub("Y", "(live)", Alive)) %>% 
  mutate(Units = ifelse(!is.na(Alive), paste(Units, Alive), Units)) %>% 
  mutate(Units = gsub("count n", "count (dead)", Units), 
         Units = gsub("count y", "count (alive)", Units),
         Units = gsub("rel. unit", "relative units", Units), 
         Units = gsub("Wt", "weight", Units),
         Units = gsub("metric tonnes n", "metric tonnes (dead)", Units))

# Fix effort units
turtles <- turtles %>%  
  mutate(effort_units = gsub("TripsObsvd", "trips", effort_units), 
         effort_units = gsub("SetsObsvd", "number of sets", effort_units), 
         effort_units = gsub("D@Sobsvd", "days at sea", effort_units), 
         effort_units = ifelse(is.na(effort), NA, effort_units))

# Fix gear types
turtles <- turtles %>% 
  left_join(gear_groups, by=c("GearGrp" = "Code")) %>% 
  mutate(gear = Name) %>% 
  mutate(gear = gsub("purse seine", "purse-seine", gear),
         gear = ifelse(is.na(gear) & GearGrp == "VS", 
                       "vessel-associated school", gear))

# Fix time periods; only keep data from the 1800s onwards
turtles <- turtles %>% 
  mutate(duration = (EndDate - StartDate) + 1, 
         time_period = ifelse(duration == 1, "yearly", paste0(duration, " years"))) %>% 
  filter(StartDate >= 1800 & EndDate > 2000)

# Fix source of data (will require adding new column to all datasets)
turtles <- turtles %>% 
  mutate(ObsvrsUsed = ifelse(ObsvrsUsed == TRUE, "observers", NA), 
         LogBksUsed = ifelse(LogBksUsed == TRUE, "logbooks", NA), 
         InterviewsUsed = ifelse(InterviewsUsed == TRUE, "interviews", NA), 
         LandingsUsed = ifelse(LandingsUsed == TRUE, "landings", NA), 
         PortSampUsed = ifelse(PortSampUsed == TRUE, "port sampling", NA), 
         FisheryIndep = ifelse(FisheryIndep == TRUE, "fishery-independent", NA)) %>%
  unite("sources", ObsvrsUsed:FisheryIndep, sep=", ", remove=TRUE, na.rm=TRUE) %>% 
  mutate(sources = gsub(", NA", "", sources), 
         sources = gsub("NA, ", "", sources), 
         sources = gsub("NA", NA, sources))

# Fix flags
turtles <- turtles %>%   
  left_join(flag_codes, by=c("Flag" = "FlagCode")) %>% 
  mutate(FlagName = gsub("Unclassified flag", NA, FlagName))

# Fix coordinates
turtles <- turtles %>% 
  mutate(latitude = (NorthLat+SouthLat)/2, 
         longitude = (EastLong+WestLong)/2, 
         spatial_notes = paste0("center of ", abs(EastLong-WestLong), "x", 
                                abs(NorthLat-SouthLat), " cell"))  %>% 
  filter(latitude < 90 & latitude > -90 & longitude < 180 & longitude > -180)

# Fix species
turtles <- turtles %>% 
  left_join(species_codes, by=c("SciName" = "Scientific_name"))

turtles <- turtles %>% 
  mutate(English_name = ifelse(is.na(English_name), SciName, English_name)) %>% 
  mutate(English_name = gsub("Turtle (unidentified)" , "turtles nei",
                             English_name), 
         SciName = gsub("Turtle (unidentified)", "turtles nei", SciName),
         English_name = gsub("Sea turtles group" , "sea turtles nei",
                             English_name),
         SciName = gsub("Sea turtles group" , "sea turtles nei",
                             SciName))

# Create relevant columns
turtles <- turtles %>% 
  mutate(rfmo = "ICCAT", 
         year = as.numeric(as.integer(StartDate)), 
         month = NA, 
         country = FlagName,  
         settype = ifelse(MeasName == "FAD|free school", MeasName, 
                          ifelse(gear == "vessel-associated school", 
                                 "associated schools", 
                                 ifelse(gear == "unassociated school", 
                                        "unassociated schools", NA))),
         catch = ObsvdValue, 
         catch_units = Units,
         is_targeted = "no",
         species_commonname = toupper(English_name), 
         species_sciname = toupper(SciName),
         measurement = NA, 
         measurement_unit = NA, 
         measurement_method = NA,
         quality_code = NA, 
         was_generated = "no", 
         sources = ifelse(sources == "", NA, sources))

# Keep only relevant columns
turtles <- turtles[,c("rfmo", "year", "month", "time_period", "country", "gear", "settype", "longitude", "latitude", "effort", "effort_units", "species_commonname", "species_sciname", "is_targeted", "catch", "catch_units", "measurement", "measurement_unit", "measurement_method", "spatial_notes", "quality_code", "was_generated", "sources")]

# Remove duplicates that were introduced when there were NAs for 2+ effort units
turtles <- turtles %>% 
  distinct_all() 

na_turtles <- turtles %>% 
  filter(is.na(effort) & is.na(effort_units))

turtles <- turtles %>% 
  filter(!is.na(effort) & !is.na(effort_units))

na_turtles <- na_turtles %>% 
  filter((!catch %in% turtles$catch) & (!species_commonname %in% turtles$species_commonname)) 

turtles <- turtles %>% 
  bind_rows(na_turtles)

# Save File
filename <- "bycatch-turtles.csv"
write.csv(turtles, paste0(save_location, filename), row.names = FALSE)

# Clean up
remove(turtles, na_turtles)
```
[Back To Top](#top)

# Combining Files
```{r, echo=TRUE}
# Find list of cleaned data
files_list <- list.files(save_location, pattern="csv")

# Make sure it doesn't include the 'all' dataset
files_list <- files_list[!grepl("all", files_list)]

# Dataframe to hold combined data
combined_dat <- NULL

# Loop through files and save to master dataframe
for(file in files_list) {
  temp <- read.csv(paste0(save_location, file))
  combined_dat <- rbind(combined_dat, temp)
}

# Save final data file for this RFMO
filename <- "iccat-all.csv"
write.csv(combined_dat, paste0(outputs_location, filename), row.names = FALSE)
```
[Back To Top](#top)

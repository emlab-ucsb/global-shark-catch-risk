---
title: "Data Cleaning for ML - All RFMO data"
output: html_notebook
---

This notebook combines RFMO catch data with SDM, SST, chl-a, and GFW data for all RFMOs using 5x5 and 1x1 degree grids.

Data that are reported in 1x1 cells are left as is. Data that are reported in 5x5 cells are converted to 1x1 cells using catch = catch/25. 

Data that are reported as counts are left as is. Data that are reported as metric tonnes are converted to count using established length-weight relationships and common lengths from Fishbase to calculate a common weight (mt). Reported catch (mt) is divided by the common weight (mt) to get count. 

```{r message=FALSE, warning=FALSE, include=FALSE}
# Load Libraries
library(tidyverse)
library(readxl)
library(googledrive)
library(sf)
library(rgdal)
```

```{r include=FALSE}
# Load Data
all_data <- read.csv("../../data/rfmo-observer-data/outputs/all_data.csv")  %>%  # for non-wcpfc data (we already cleaned wcpfc)
  filter(rfmo != "WCPFC")

cleaned_wcpfc <- read.csv("../../data/model-data/inputs/wcpfc-only-model/wcpfc_all.csv") %>% 
    filter(gear == "longline" & 
             catch_units == "count" & 
             effort_units == "hooks") %>% 
    mutate_if(is_character, as.factor) %>% 
    arrange(year, latitude, longitude) %>%
  filter(target_sources == "self-reported catch and effort by flag + year") %>%
  select(-colnames(prep_ll %>% # remove columns where target effort or catch sums to 0
                              dplyr::select_if(grepl("target_effort|target_catch", colnames(.))) %>% 
                              dplyr::select_if(colSums(.) == 0))) %>% 
    filter(!is.na(target_effort))

# Species grouping
species_groups <- read_xlsx("../../data/species-information/species_groups.xlsx", sheet = "species_list") %>% 
  filter(group %in% c("tunas", "tuna-like species", "sharks and rays")) %>% 
  mutate(scientific_name = str_to_upper(scientific_name))

# SDM data
all_sdm <- read.csv("../../data/iucn-sdm-data/outputs/global_combined_iucn_sdm_1x1.csv")
all_sdm_5x5 <- read.csv("../../data/iucn-sdm-data/outputs/global_combined_iucn_sdm_5x5.csv")

# SST data
sst_data <- read.csv("../../data/sea-surface-temperature/outputs/binned_global_sst_1x1.csv")
sst_data_5x5 <- read.csv("../../data/sea-surface-temperature/outputs/binned_global_sst_5x5.csv")

# Chlorophyll-A data
chla_data <- read.csv("../../data/chlorophyll-a/outputs/binned_global_chla_1x1.csv")
chla_data_5x5 <- read.csv("../../data/chlorophyll-a/outputs/binned_global_chla_5x5.csv")

# GFW data
gfw_data <- read.csv("../../data/global-fishing-watch/outputs/binned_global_gfw_1x1.csv")
gfw_data_5x5 <- read.csv("../../data/global-fishing-watch/outputs/binned_global_gfw_5x5.csv")

# Group price data
# Ex-vessel price data
prices <- read.csv("../../data/ex-vessel-prices/exvessel_price_database_1976_2017.csv")

prices <- prices %>% 
  mutate(ASFIS_species = str_to_upper(ASFIS_species), 
         scientific_name = str_to_upper(scientific_name), 
         ASFIS_species = case_when(ASFIS_species == "INDO-PACIF. BOTTLENOSE DOLPHIN" ~  "INDO-PACIFIC BOTTLENOSE DOLPHIN", 
                                   ASFIS_species == "SHORTFIN MAKO" ~ "SHORTFIN MAKO SHARK", 
                                   ASFIS_species == "ALBACORE" ~ "ALBACORE TUNA", 
                                   TRUE ~ ASFIS_species), 
         ISSCAAP_group = case_when(ISSCAAP_group == "Sharks, rays, chimaeras" ~ "sharks and rays", 
                                   ISSCAAP_group == "Miscellaneous aquatic mammals" ~ "marine mammals", 
                                   ISSCAAP_group == "Turtles" ~ "turtles", 
                                   TRUE ~ paste(ISSCAAP_group))) %>% 
  rename(year = Year, 
         species_commonname = ASFIS_species, 
         species_group = ISSCAAP_group)
```

```{r message=FALSE, warning=FALSE}
# Cut down a bit if can... 
short_data <- NULL 

# But some splits we have to do by rfmo... 
for(rfmos in unique(all_data$rfmo)) { 
  
  temp <- all_data %>% 
    filter(rfmo == rfmos &
             spatial_notes %in% c("center of 5x5 cell", "center of 1x1 cell") &
           gear_group == "longline" & #effort_units == "hooks" &
             catch_units %in% c("metric tonnes", "count") & 
           was_generated == "no" &
           year <= 2018)

  # if(rfmos == "WCPFC") { 
  #   temp <- temp %>% 
  #     filter(sources %in% c("bycatch and effort from observers",
  #                           "self-reported catch and effort by flag + year")) %>% 
  #     mutate(aggregation_period = "yearly")
  # } else { 
      temp <- temp %>%
        select(rfmo, year, country, latitude, longitude, gear_group, time_period, effort, effort_units, spatial_notes, 
               species_commonname, species_sciname, catch, catch_units) %>% 
        distinct_all() %>% 
        group_by(rfmo, year, country, latitude, longitude, gear_group, time_period, effort_units,
                 spatial_notes, species_commonname, species_sciname, catch_units) %>% 
        summarise(catch = sum(catch, na.rm = T), 
                  effort = sum(effort, na.rm = T)) %>% 
        ungroup() %>% 
        mutate(was_generated = "yes", 
               aggregation_period = time_period, 
               time_period = "yearly") %>% 
        filter(aggregation_period == "monthly")
  # }
  
  short_data <- short_data %>% 
    bind_rows(temp)
} 

# Calculate effort for model runs
effort_pivot <- short_data %>% 
  filter(effort_units == "hooks") %>% 
  dplyr::select(rfmo, year, country, latitude, longitude, gear_group, time_period, effort_units, effort, spatial_notes) %>% 
  distinct_all() %>% 
  group_by(rfmo, year, country, latitude, longitude, gear_group, time_period, effort_units, spatial_notes) %>% 
  summarise(effort = sum(effort, na.rm = T)) %>% 
  ungroup()

effort_pivot <- effort_pivot %>% 
  group_by(rfmo, year, latitude, longitude, gear_group, time_period, effort_units, spatial_notes) %>% 
  summarise(total_effort = sum(effort, na.rm = T)) %>% 
  ungroup() %>%
  full_join(effort_pivot  %>%
               pivot_wider(names_from = country, 
                           values_from = effort, 
                           values_fn = sum, 
                           values_fill = 0), 
            by = c("year","rfmo", "time_period", "latitude", "longitude", "gear_group", "effort_units", "spatial_notes")) 

colnames(effort_pivot)[10:ncol(effort_pivot)] <- paste0("total_effort_",colnames(effort_pivot)[10:ncol(effort_pivot)])
  
  
# Combine to remove the country specific data (since the best model doesn't use it)
short_data <- short_data %>% 
  mutate(species_sciname = ifelse(is.na(species_sciname), species_commonname, species_sciname)) %>%
  group_by(rfmo, year, latitude, longitude, gear_group, effort_units, species_commonname, spatial_notes,
           species_sciname, catch_units) %>% 
  summarise(catch = sum(catch, na.rm = T)) %>% 
  ungroup() 

names <- short_data %>% 
  dplyr::select(species_commonname, species_sciname) %>% 
  distinct_all()

short_data2 <- short_data %>% 
  full_join(., effort_pivot) %>%
  mutate(species_sciname = ifelse(is.na(species_sciname), "empty", species_sciname))

# pad with zeros...
short_data2 <- short_data %>%
  dplyr::select(-species_commonname) %>%
  pivot_wider(names_from = c(year, species_sciname, catch_units),
              values_fn = sum,
              values_from = catch,
              values_fill = 0) %>%
  pivot_longer(cols = colnames(.)[!grepl("latitude|longitude|rfmo|gear_group|effort_units|spatial_notes", colnames(.))],
               names_to = c("year","species_sciname", "catch_units"),
               names_sep = "_",
               values_to = "catch")

short_data <- short_data %>% 
  left_join(names) %>% 
  left_join(species_groups %>% 
              rename(species_group = group, 
                     species_commonname = english_name) %>% 
              mutate(species_commonname = str_to_upper(species_commonname)) %>% 
              select(-species_commonname),
            by = c("species_sciname" = "scientific_name")) %>% 
  select(rfmo, year, latitude, longitude, gear_group, effort_units, species_group, spatial_notes,
         species_commonname, species_sciname, catch, catch_units) %>%
  mutate(species_sciname = case_when(species_sciname == "TETRAPTURUS AUDAX" ~ "KAJIKIA AUDAX",
                                     species_sciname == "MAKAIRA INDICA" ~ "ISTIOMPAX INDICA", 
                                     species_sciname == "TETRAPTURUS ALBIDUS" ~ "KAJIKIA ALBIDA",
                                     species_sciname == "TETRAPTURUS PFLUEGERI" ~ "TETRAPTURUS PFLUEGERI", 
                                     TRUE ~ species_sciname))

# how much data contributed to "nei"s
short_data <- short_data %>% 
  mutate(species_group = case_when(is.na(species_group) & 
                                     grepl("NEI|OTHER", species_commonname) & 
                                     grepl("SHARK", species_commonname) ~ "sharks and rays", 
                                   species_commonname == "SILKY OR BLACKTIP SHARK" ~ "sharks and rays",
                                   is.na(species_group) & 
                                     grepl("NEI|OTHER", species_commonname) & 
                                     grepl("MARLIN|BILLFISH|TUNA-LIKE", species_commonname) ~ "tuna-like species", 
                                   species_commonname == "FRIGATE AND BULLET TUNAS" ~ "tunas",
                                   is.na(species_group) & 
                                     grepl("NEI|OTHER", species_commonname) & 
                                     grepl("TUNA", species_commonname) ~ "tunas",
                                   TRUE ~ species_group))

# Now standardize nei species if can...
short_data <- short_data %>%
  mutate(species_resolution = case_when(grepl("NEI|OTHER|SPP", species_commonname) ~ "NEI",
                                        grepl("NEI|OTHER|SPP", species_sciname) ~ "NEI",
                                        species_commonname == "SILKY OR BLACKTIP SHARK" ~ "NEI",
                                        species_commonname == "FRIGATE AND BULLET TUNAS" ~ "NEI",
                                        !grepl(" ", species_sciname) ~ "NEI",
                                        TRUE ~ "SPECIES SPECIFIC"),
         species_commonname = case_when(species_commonname == "OTHER SHARKS" ~ "SHARKS NEI",
                                        species_commonname == "OTHER TUNA" ~ "TUNAS NEI",
                                        TRUE ~ species_commonname),
         species_sciname = case_when(species_commonname == "TUNAS NEI" ~ "THUNNUS",
                                     species_commonname == "SHARKS NEI" ~ "SHARKS NEI", 
                                     is.na(species_sciname) ~ species_commonname,
                                     TRUE ~ gsub(" SPP|[.]", "", species_sciname)))

# Only keep species for sharks and rays
short_data <- short_data %>%
  filter(species_group %in% c("sharks and rays")) %>%  # only run using shark and ray datasets
  bind_rows(cleaned_wcpfc)
```

# Combine the data

```{r}
combined_data <- short_data %>%
  mutate(year = as.integer(year)) %>% 
  filter(spatial_notes == "center of 5x5 cell" & catch_units == "count") %>% 
  filter(year >= 2012 & year <= 2018) %>% # lower limit for GFW data
  left_join(all_sdm_5x5 %>% distinct_all()) %>% 
  left_join(gfw_data_5x5 %>% distinct_all()) %>% 
  left_join(sst_data_5x5 %>% distinct_all()) %>% 
  left_join(chla_data_5x5 %>% distinct_all()) %>% 
  filter(!is.na(mean_chla) | !is.na(mean_sst)) %>%
  filter(!is.na(sdm))

write.csv(combined_data,
          "../../data/model-data/inputs/all-rfmo-models/global_ll_data_5x5_count.csv",
          row.names = FALSE)
```

# Convert mt to count

```{r}
# Update mt to count
mt_count <- read.csv("../../data/species-information/spp_weight_count_conversion.csv") %>%
  mutate(scientific_name = str_to_upper(scientific_name))

# Add sharks nei to the mix
mt_count <- mt_count %>%
  bind_rows(data.frame(scientific_name = "SHARKS NEI",
                       common_weight_kg = mean(mt_count$common_weight_kg, na.rm = T))) %>%
  mutate(common_weight_mt = common_weight_kg/1000) %>%
  dplyr::select(scientific_name, common_weight_mt)

# Run conversions
short_data_mt <- short_data %>%
  filter(catch_units == "metric tonnes") %>%
  left_join(mt_count, by = c("species_sciname" = "scientific_name")) %>%
  mutate(catch = catch/common_weight_mt,
         catch_units = "count") %>%
  select(colnames(short_data))

# Add back to dataset
short_data2 <- short_data %>%
  filter(catch_units == "count") %>%
  bind_rows(short_data_mt) %>%
  group_by(rfmo, year, latitude, longitude, gear_group, species_group, spatial_notes, species_commonname, species_sciname, catch_units, species_resolution) %>%
  summarise(catch = sum(catch, na.rm = T)) %>%
  ungroup()
```

# Combine the data

```{r}
combined_data <- short_data2 %>%
  mutate(year = as.integer(year)) %>% 
  filter(spatial_notes == "center of 5x5 cell") %>% 
  filter(year >= 2012 & year <= 2018) %>% # lower limit for GFW data
  left_join(all_sdm_5x5 %>% distinct_all()) %>% 
  left_join(gfw_data_5x5 %>% distinct_all()) %>% 
  left_join(sst_data_5x5 %>% distinct_all()) %>% 
  left_join(chla_data_5x5 %>% distinct_all()) %>% 
  filter(!is.na(mean_chla) | !is.na(mean_sst)) %>%
  filter(!is.na(sdm))

write.csv(combined_data, 
          "../../data/model-data/inputs/all-rfmo-models/global_ll_data_5x5_mt_to_count.csv", 
          row.names = FALSE)
```

# Convert to 1x1 degrees

```{r rescale-rfmo-data}
# Rescale to 1x1 degree 
locations_y <- short_data %>%
  filter(spatial_notes == "center of 5x5 cell") %>%
  select(latitude) %>%
  distinct_all() %>%
  mutate(latitude_lag0 = latitude,
         latitude_lag1 = latitude-1,
         latitude_lag2 = latitude-2,
         latitude_plus1 = latitude+1,
         latitude_plus2 = latitude+2) %>%
  pivot_longer(latitude_lag0:latitude_plus2, values_to = "latitude_rescaled") %>%
  select(-name)

locations_x <- short_data %>%
  filter(spatial_notes == "center of 5x5 cell") %>%
  select(longitude) %>%
  distinct_all() %>%
  mutate(longitude_lag0 = longitude,
         longitude_lag1 = longitude-1,
         longitude_lag2 = longitude-2,
         longitude_plus1 = longitude+1,
         longitude_plus2 = longitude+2) %>%
  pivot_longer(longitude_lag0:longitude_plus2, values_to = "longitude_rescaled") %>%
  select(-name)

# New dataset
short_data_5x5 <- short_data %>%
  filter(spatial_notes == "center of 5x5 cell") %>%
  left_join(locations_y) %>%
  left_join(locations_x) %>%
  mutate(longitude_rescaled = ifelse(is.na(longitude_rescaled), longitude, longitude_rescaled),
         latitude_rescaled = ifelse(is.na(latitude_rescaled), latitude, latitude_rescaled),
         catch = catch/25) %>%
  rename(latitude_orig = latitude,
         longitude_orig = longitude,
         latitude = latitude_rescaled,
         longitude = longitude_rescaled) %>%
  mutate(spatial_notes = "center of 1x1 cell") %>%
  select(colnames(short_data))

short_data <- short_data %>%
  filter(spatial_notes != "center of 5x5 cell") %>%
  bind_rows(short_data_5x5)
```

# Combine the data

```{r}
combined_data <- short_data %>%
  mutate(year = as.integer(year)) %>% 
  filter(catch_units == "count") %>% 
  filter(year >= 2012 & year <= 2018) %>% # lower limit for GFW data
  left_join(all_sdm %>% distinct_all()) %>% 
  left_join(gfw_data %>% distinct_all()) %>% 
  left_join(sst_data %>% distinct_all()) %>% 
  left_join(chla_data %>% distinct_all()) %>% 
  filter(!is.na(mean_chla) | !is.na(mean_sst)) %>%
  filter(!is.na(sdm))

write.csv(combined_data, 
          "../../data/model-data/inputs/all-rfmo-models/global_ll_data_1x1_count.csv", 
          row.names = FALSE)
```

# Convert mt to count

```{r}
# Update mt to count
mt_count <- read.csv("../../data/species-information/spp_weight_count_conversion.csv") %>%
  mutate(scientific_name = str_to_upper(scientific_name))

# Add sharks nei to the mix
mt_count <- mt_count %>%
  bind_rows(data.frame(scientific_name = "SHARKS NEI",
                       common_weight_kg = mean(mt_count$common_weight_kg, na.rm = T))) %>%
  mutate(common_weight_mt = common_weight_kg/1000) %>%
  dplyr::select(scientific_name, common_weight_mt)

# Run conversions
short_data_mt <- short_data %>%
  filter(catch_units == "metric tonnes") %>%
  left_join(mt_count, by = c("species_sciname" = "scientific_name")) %>%
  mutate(catch = catch/common_weight_mt,
         catch_units = "count") %>%
  select(colnames(short_data))

# Add back to dataset
short_data <- short_data %>%
  filter(catch_units == "count") %>%
  bind_rows(short_data_mt) %>%
  group_by(rfmo, year, latitude, longitude, gear_group, species_group, spatial_notes, species_commonname, species_sciname, catch_units, species_resolution) %>%
  summarise(catch = sum(catch, na.rm = T)) %>%
  ungroup()
```

# Combine the data

```{r}
combined_data <- short_data %>%
  mutate(year = as.integer(year)) %>% 
  filter(year >= 2012 & year <= 2018) %>% # lower limit for GFW data
  left_join(all_sdm %>% distinct_all()) %>% 
  left_join(gfw_data %>% distinct_all()) %>% 
  left_join(sst_data %>% distinct_all()) %>% 
  left_join(chla_data %>% distinct_all()) %>% 
  filter(!is.na(mean_chla) | !is.na(mean_sst)) %>%
  filter(!is.na(sdm))

write.csv(combined_data, 
          "../../data/model-data/inputs/all-rfmo-models/global_ll_data_1x1_mt_to_count.csv", 
          row.names = FALSE)
```

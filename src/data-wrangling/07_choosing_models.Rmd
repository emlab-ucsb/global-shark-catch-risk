---
title: "Choosing the Right Model"
output: 
  rmarkdown::pdf_document:
    toc: yes
    fig_caption: yes
    includes:
      in_header: ../header.tex
---

This script tests the difference in spatial distribution data (5x5 or 1x1 cells) among the RFMOs to determine which model might be the most appropriate.

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r}
# Load Libraries
library(raster)
library(tidyverse)
library(readxl)
library(googledrive)
library(sf)
library(rgdal)
library(cowplot)
```


```{r}
# Load data
all_data <- read.csv("../../data/rfmo-observer-data/outputs/all_data.csv") 

# Species grouping
species_groups <- read_xlsx("../../data/species-information/species_groups.xlsx", sheet = "species_list") %>% 
  filter(group %in% c("tunas", "tuna-like species", "sharks and rays")) %>% 
  mutate(scientific_name = str_to_upper(scientific_name))
```

# Raw Data Summary 

Below represents the breakdown of reported bycatch data (number of rows) in each combination of categories: 5x5 reporting resolution, 1x1 reporting resolution, metric tonnes, and count. 

```{r}
# Cut down a bit if can... 
short_data <- NULL 

# But some splits we have to do by rfmo... 
for(rfmos in unique(all_data$rfmo)) { 
  
  temp <- all_data %>% 
    filter(rfmo == rfmos &
             spatial_notes %in% c("center of 5x5 cell", "center of 1x1 cell") &
           gear_group == "longline" & effort_units == "hooks" &
           was_generated == "no" &
           year <= 2018)

  if(rfmos == "WCPFC") { 
    temp <- temp %>% 
      filter(sources %in% c("bycatch and effort from observers",
                            "self-reported catch and effort by flag + year")) %>% 
      mutate(aggregation_period = "yearly")
  } else { 
      temp <- temp %>%
        group_by(rfmo, year, latitude, longitude, gear_group, time_period, effort_units,
                 spatial_notes, species_commonname, species_sciname, catch_units) %>% 
        summarise(catch = sum(catch, na.rm = T)) %>% 
        ungroup() %>% 
        mutate(was_generated = "yes", 
               aggregation_period = time_period, 
               time_period = "yearly") %>% 
        filter(aggregation_period == "monthly")
  }
  
  short_data <- short_data %>% 
    bind_rows(temp)
} 

# Combine to remove the country specific data (since the best model doesn't use it)
short_data <- short_data %>% 
  mutate(species_sciname = ifelse(is.na(species_sciname), species_commonname, species_sciname)) %>%
  group_by(rfmo, year, latitude, longitude, gear_group, effort_units, species_commonname, spatial_notes,
           species_sciname, catch_units) %>% 
  summarise(catch = sum(catch, na.rm = T)) %>% 
  ungroup() 

# Change some scientific names that throw issues
short_data <- short_data %>% 
  left_join(species_groups %>% 
              rename(species_group = group, 
                     species_commonname = english_name) %>% 
              mutate(species_commonname = str_to_upper(species_commonname)) %>% 
              select(-species_commonname),
            by = c("species_sciname" = "scientific_name")) %>% 
  select(rfmo, year, latitude, longitude, gear_group, effort_units, species_group, spatial_notes,
         species_commonname, species_sciname, catch, catch_units) %>%
  mutate(species_sciname = case_when(species_sciname == "TETRAPTURUS AUDAX" ~ "KAJIKIA AUDAX",
                                     species_sciname == "MAKAIRA INDICA" ~ "ISTIOMPAX INDICA", 
                                     species_sciname == "TETRAPTURUS ALBIDUS" ~ "KAJIKIA ALBIDA",
                                     species_sciname == "TETRAPTURUS PFLUEGERI" ~ "TETRAPTURUS PFLUEGERI", 
                                     TRUE ~ species_sciname))

# how much data contributed to "nei"s
short_data <- short_data %>% 
  mutate(species_group = case_when(is.na(species_group) & 
                                     grepl("NEI|OTHER", species_commonname) & 
                                     grepl("SHARK", species_commonname) ~ "sharks and rays", 
                                   species_commonname == "SILKY OR BLACKTIP SHARK" ~ "sharks and rays",
                                   is.na(species_group) & 
                                     grepl("NEI|OTHER", species_commonname) & 
                                     grepl("MARLIN|BILLFISH|TUNA-LIKE", species_commonname) ~ "tuna-like species", 
                                   species_commonname == "FRIGATE AND BULLET TUNAS" ~ "tunas",
                                   is.na(species_group) & 
                                     grepl("NEI|OTHER", species_commonname) & 
                                     grepl("TUNA", species_commonname) ~ "tunas",
                                   TRUE ~ species_group))

# Now standardize nei species if can...
short_data <- short_data %>%
  mutate(species_resolution = case_when(grepl("NEI|OTHER|SPP", species_commonname) ~ "NEI",
                                        grepl("NEI|OTHER|SPP", species_sciname) ~ "NEI",
                                        species_commonname == "SILKY OR BLACKTIP SHARK" ~ "NEI",
                                        species_commonname == "FRIGATE AND BULLET TUNAS" ~ "NEI",
                                        !grepl(" ", species_sciname) ~ "NEI",
                                        TRUE ~ "SPECIES SPECIFIC"),
         species_commonname = case_when(species_commonname == "OTHER SHARKS" ~ "SHARKS NEI",
                                        species_commonname == "OTHER TUNA" ~ "TUNAS NEI",
                                        TRUE ~ species_commonname),
         species_sciname = case_when(species_commonname == "TUNAS NEI" ~ "THUNNUS",
                                     species_commonname == "SHARKS NEI" ~ "SHARKS NEI", 
                                     is.na(species_sciname) ~ species_commonname,
                                     TRUE ~ gsub(" SPP|[.]", "", species_sciname)))

# Only keep species for sharks and rays
short_data <- short_data %>%
  filter(species_group %in% c("sharks and rays") & catch > 0) # only run using shark and ray datasets
```

```{r}
short_data_table <- short_data %>% 
  group_by(rfmo, spatial_notes, catch_units) %>% 
  summarise(n_rows = n()) %>% 
  ungroup() %>% 
  left_join(short_data %>% 
              group_by(rfmo) %>% 
              summarise(n_total = n()) %>% 
              ungroup()) %>% 
  mutate(perc_total = n_rows/n_total*100) %>% 
  select(rfmo, spatial_notes, catch_units, perc_total)

ggplot() + 
  geom_bar(data = short_data_table %>% 
                   mutate(group = paste0(spatial_notes, " (", catch_units, ")")), mapping = aes(x = rfmo, weight = perc_total, fill = group)) + 
  scale_fill_manual("", values = c("center of 1x1 cell (count)" = "lightskyblue1", 
                                   "center of 1x1 cell (metric tonnes)" = "lightskyblue4", 
                                   "center of 5x5 cell (count)" = "darkolivegreen3", 
                                   "center of 5x5 cell (metric tonnes)" = "darkolivegreen")) + 
  ylab("% of all data (rows)") + xlab("") + 
  theme_classic()
```

```{r}
# Location for model outputs
open_loc = "../../data/model-data/outputs/all-rfmo-models/"

land_low_res_moll <- raster::raster("../../data/mapping-templates/land_low_res_moll.tif")
land_low_res_moll <- projectRaster(land_low_res_moll, crs = 4326)
```

# IATTC

All bycatch data from IATTC were reported at a 5x5 degree grid as counts or metric tonnes. 

We ran four models: 

1. IATTC data used in its native resolution (5x5 degree) for count only.
2. IATTC data used in its native resolution (5x5 degree) for count and metric tonnes (converted to count using weight-length relationships).
3. IATTC data re-distributed to a finer resolution (1x1 degree) for count only by equally distributing the catch into 25 smaller cells. For example, if 100 blue sharks were caught in a 5x5 cell, each smaller 1x1 cell within the larger area will have a catch of 100/25 = 4 blue sharks.
4. IATTC data re-distributed to a finer resolution (1x1 degree) for count and metric tonnes (converted to count using weight-length relationships) by equally distributing the catch into 25 smaller cells. For example, if 100 blue sharks were caught in a 5x5 cell, each smaller 1x1 cell within the larger area will have a catch of 100/25 = 4 blue sharks.

```{r}
# Load data
iattc_option1 <- readRDS(file.path(open_loc, "5x5_count_IATTC_untuned_trained_model.rds"))
iattc_option2 <- readRDS(file.path(open_loc, "5x5_mt_to_count_IATTC_untuned_trained_model.rds"))
iattc_option3 <- readRDS(file.path(open_loc, "1x1_count_IATTC_untuned_trained_model.rds"))
iattc_option4 <- readRDS(file.path(open_loc, "1x1_mt_to_count_IATTC_untuned_trained_model.rds"))

# Show Model metrics
knitr::kable(iattc_option1$metrics %>%
               mutate(spatial_resolution = "5x5 degree cells", 
                      catch_resolution = "count only") %>% 
               bind_rows(iattc_option2$metrics %>% 
                           mutate(spatial_resolution = "5x5 degree cells", 
                                  catch_resolution = "count and metric tonnes converted to count")) %>% 
               bind_rows(iattc_option3$metrics %>% 
                           mutate(spatial_resolution = "1x1 degree cells", 
                                  catch_resolution = "count only")) %>% 
               bind_rows(iattc_option4$metrics %>% 
                           mutate(spatial_resolution = "1x1 degree cells", 
                                  catch_resolution = "count and metric tonnes converted to count")) %>% 
               select(spatial_resolution, catch_resolution, rmse, rsq, mae) %>% 
               arrange(desc(rsq)) %>%
               rename(`Spatial Resolution` = spatial_resolution, 
                      `Catch Resolution` = catch_resolution,
                      `Root Mean Squared Error` = rmse, 
                      `R Squared` = rsq, 
                      `Mean Absolute Error` = mae), 
             caption = "IATTC Model Results", digits = 3)
```

```{r fig.cap= "IATTC Model Results.", fig.width= 8, fig.height=16}
# Show figures
# Fix rasterize
iattc_raster_1x1 <- raster::raster(xmx = 179.5, xmn = -179.5, ymn = -89.5, ymx = 89.5, crs = 4326, resolution = 1)
iattc_raster_5x5 <- raster::raster(xmx = 177.5, xmn = -177.5, ymn = -87.5, ymx = 87.5, crs = 4326, resolution = 5)

# True Catch - 5x5 for count
iattc_true_df_5x5_count <- iattc_option1$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iattc_raster_5x5,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iattc_true_plot_5x5_count <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iattc_true_df_5x5_count, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 1 Catch
iattc_option1_df <- iattc_option1$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iattc_raster_5x5,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iattc_option1_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iattc_option1_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# True Catch - 5x5 for count and mt
iattc_true_df_5x5_mt <- iattc_option2$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iattc_raster_5x5,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90))

iattc_true_plot_5x5_mt <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iattc_true_df_5x5_mt, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 2 Catch
iattc_option2_df <- iattc_option2$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iattc_raster_5x5,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iattc_option2_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iattc_option2_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# True Catch -1x1
iattc_true_df_1x1_count <- iattc_option3$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iattc_raster_1x1,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iattc_true_plot_1x1_count <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iattc_true_df_1x1_count, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 3 Catch
iattc_option3_df <- iattc_option3$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iattc_raster_1x1,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90))

iattc_option3_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iattc_option3_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# True Catch -1x1 for count and mt
iattc_true_df_1x1_mt <- iattc_option4$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iattc_raster_1x1,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90))

iattc_true_plot_1x1_mt <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iattc_true_df_1x1_mt, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 4 Catch
iattc_option4_df <- iattc_option4$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iattc_raster_1x1,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iattc_option4_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iattc_option4_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Combined plot
ggdraw() + 
  draw_plot(iattc_true_plot_5x5_count, 0, 0.75, 0.5, 0.25) + 
  draw_plot(iattc_option1_plot, 0.5, 0.75, 0.5, 0.25) + 
  draw_plot(iattc_true_plot_5x5_mt, 0, 0.5, 0.5, 0.25) + 
  draw_plot(iattc_option2_plot, 0.5, 0.5, 0.5, 0.25) +
  draw_plot(iattc_true_plot_1x1_count, 0, 0.25, 0.5, 0.25) +
  draw_plot(iattc_option3_plot, 0.5, 0.25, 0.5, 0.25) +
  draw_plot(iattc_true_plot_1x1_mt, 0, 0, 0.5, 0.25) +
  draw_plot(iattc_option4_plot, 0.5, 0, 0.5, 0.25) + 
  draw_plot_label(label = c("A) Observed Catch\n(5x5 Degree Grid; count)", "B) Predicted Catch\n(5x5 Degree Grid; count)", 
                            "C) Observed Catch\n(5x5 Degree Grid; count and mt)", "D) Predicted Catch\n(5x5 Degree Grid; count and mt)", 
                            "E) Observed Catch\n(1x1 Degree Grid; count)",  "F) Predicted Catch\n(1x1 Degree Grid; count)", 
                            "G) Observed Catch\n(1x1 Degree Grid; count and mt)", "H) Predicted Catch\n(1x1 Degree Grid; count and mt)"), 
                  x = rep(c(0, 0.5), 4), y = rep(c(0.99, 0.74, 0.49, 0.24), each = 2), hjust = 0, vjust = 1)
```


# ICCAT

All bycatch data from ICCAT were reported at a 5x5 degree grid and a 1x1 degree grid as counts or metric tonnes. Most bycatch data was reported at a 5x5 degree grid as metric tonnes.

We ran four models: 

1. ICCAT data at a 5x5 resolution for count only.
2. ICCAT data at a 5x5 resolution for count and metric tonnes (converted to count using weight-length relationships).
3. ICCAT data at a 1x1 resolution, with data originally in a 5x5 resolution re-distributed to a finer resolution (1x1 degree) for count only by equally distributing the catch into 25 smaller cells. For example, if 100 blue sharks were caught in a 5x5 cell, each smaller 1x1 cell within the larger area will have a catch of 100/25 = 4 blue sharks.
4. ICCAT data at a 1x1 resolution, with data originally in a 5x5 resolution re-distributed to a finer resolution (1x1 degree) for count and metric tonnes (converted to count using weight-length relationships) by equally distributing the catch into 25 smaller cells. For example, if 100 blue sharks were caught in a 5x5 cell, each smaller 1x1 cell within the larger area will have a catch of 100/25 = 4 blue sharks.

```{r}
# Load data
iccat_option1 <- readRDS(file.path(open_loc, "5x5_count_ICCAT_untuned_trained_model.rds"))
iccat_option2 <- readRDS(file.path(open_loc, "5x5_mt_to_count_ICCAT_untuned_trained_model.rds"))
iccat_option3 <- readRDS(file.path(open_loc, "1x1_count_ICCAT_untuned_trained_model.rds"))
iccat_option4 <- readRDS(file.path(open_loc, "1x1_mt_to_count_ICCAT_untuned_trained_model.rds"))

# Show Model metrics
knitr::kable(iccat_option1$metrics %>%
               mutate(spatial_resolution = "5x5 degree cells", 
                      catch_resolution = "count only") %>% 
               bind_rows(iccat_option2$metrics %>% 
                           mutate(spatial_resolution = "5x5 degree cells", 
                                  catch_resolution = "count and metric tonnes converted to count")) %>% 
               bind_rows(iccat_option3$metrics %>% 
                           mutate(spatial_resolution = "1x1 degree cells", 
                                  catch_resolution = "count only")) %>% 
               bind_rows(iccat_option4$metrics %>% 
                           mutate(spatial_resolution = "1x1 degree cells", 
                                  catch_resolution = "count and metric tonnes converted to count")) %>% 
               select(spatial_resolution, catch_resolution, rmse, rsq, mae) %>% 
               arrange(desc(rsq)) %>%
               rename(`Spatial Resolution` = spatial_resolution, 
                      `Catch Resolution` = catch_resolution,
                      `Root Mean Squared Error` = rmse, 
                      `R Squared` = rsq, 
                      `Mean Absolute Error` = mae), 
             caption = "ICCAT Model Results", digits = 3)
```

```{r fig.cap= "ICCAT Model Results.", fig.width= 8, fig.height=16}
# Show figures
# Fix rasterize
iccat_raster_1x1 <- raster::raster(xmx = 179.5, xmn = -179.5, ymn = -89.5, ymx = 89.5, crs = 4326, resolution = 1)
iccat_raster_5x5 <- raster::raster(xmx = 177.5, xmn = -177.5, ymn = -87.5, ymx = 87.5, crs = 4326, resolution = 5)

# True Catch - 5x5 for count
iccat_true_df_5x5_count <- iccat_option1$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iccat_raster_5x5,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iccat_true_plot_5x5_count <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iccat_true_df_5x5_count, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 1 Catch
iccat_option1_df <- iccat_option1$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iccat_raster_5x5,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iccat_option1_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iccat_option1_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# True Catch - 5x5 for count and mt
iccat_true_df_5x5_mt <- iccat_option2$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iccat_raster_5x5,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iccat_true_plot_5x5_mt <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iccat_true_df_5x5_mt, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 2 Catch
iccat_option2_df <- iccat_option2$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iccat_raster_5x5,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iccat_option2_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iccat_option2_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# True Catch -1x1
iccat_true_df_1x1_count <- iccat_option3$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iccat_raster_1x1,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iccat_true_plot_1x1_count <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iccat_true_df_1x1_count, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 3 Catch
iccat_option3_df <- iccat_option3$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iccat_raster_1x1,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90))

iccat_option3_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iccat_option3_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# True Catch -1x1 for count and mt
iccat_true_df_1x1_mt <- iccat_option4$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iccat_raster_1x1,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iccat_true_plot_1x1_mt <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iccat_true_df_1x1_mt, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 4 Catch
iccat_option4_df <- iccat_option4$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iccat_raster_1x1,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90))

iccat_option4_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iccat_option4_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Combined plot
ggdraw() + 
  draw_plot(iccat_true_plot_5x5_count, 0, 0.75, 0.5, 0.25) + 
  draw_plot(iccat_option1_plot, 0.5, 0.75, 0.5, 0.25) + 
  draw_plot(iccat_true_plot_5x5_mt, 0, 0.5, 0.5, 0.25) + 
  draw_plot(iccat_option2_plot, 0.5, 0.5, 0.5, 0.25) +
  draw_plot(iccat_true_plot_1x1_count, 0, 0.25, 0.5, 0.25) +
  draw_plot(iccat_option3_plot, 0.5, 0.25, 0.5, 0.25) +
  draw_plot(iccat_true_plot_1x1_mt, 0, 0, 0.5, 0.25) +
  draw_plot(iccat_option4_plot, 0.5, 0, 0.5, 0.25) + 
  draw_plot_label(label = c("A) Observed Catch\n(5x5 Degree Grid; count)", "B) Predicted Catch\n(5x5 Degree Grid; count)", 
                            "C) Observed Catch\n(5x5 Degree Grid; count and mt)", "D) Predicted Catch\n(5x5 Degree Grid; count and mt)", 
                            "E) Observed Catch\n(1x1 Degree Grid; count)",  "F) Predicted Catch\n(1x1 Degree Grid; count)", 
                            "G) Observed Catch\n(1x1 Degree Grid; count and mt)", "H) Predicted Catch\n(1x1 Degree Grid; count and mt)"), 
                  x = rep(c(0, 0.5), 4), y = rep(c(0.99, 0.74, 0.49, 0.24), each = 2), hjust = 0, vjust = 1)
```

# IOTC

All bycatch data from IOTC were reported at a 5x5 degree grid and a 1x1 degree grid as counts or metric tonnes. Most bycatch data was reported at a 5x5 degree grid.

We ran four models: 

1. IOTC data at a 5x5 resolution for count only.
2. IOTC data at a 5x5 resolution for count and metric tonnes (converted to count using weight-length relationships).
3. IOTC data at a 1x1 resolution, with data originally in a 5x5 resolution re-distributed to a finer resolution (1x1 degree) for count only by equally distributing the catch into 25 smaller cells. For example, if 100 blue sharks were caught in a 5x5 cell, each smaller 1x1 cell within the larger area will have a catch of 100/25 = 4 blue sharks.
4. IOTC data at a 1x1 resolution, with data originally in a 5x5 resolution re-distributed to a finer resolution (1x1 degree) for count and metric tonnes (converted to count using weight-length relationships) by equally distributing the catch into 25 smaller cells. For example, if 100 blue sharks were caught in a 5x5 cell, each smaller 1x1 cell within the larger area will have a catch of 100/25 = 4 blue sharks.

```{r}
# Load data
iotc_option1 <- readRDS(file.path(open_loc, "5x5_count_IOTC_untuned_trained_model.rds"))
iotc_option2 <- readRDS(file.path(open_loc, "5x5_mt_to_count_IOTC_untuned_trained_model.rds"))
iotc_option3 <- readRDS(file.path(open_loc, "1x1_count_IOTC_untuned_trained_model.rds"))
iotc_option4 <- readRDS(file.path(open_loc, "1x1_mt_to_count_IOTC_untuned_trained_model.rds"))

# Show Model metrics
knitr::kable(iotc_option1$metrics %>%
               mutate(spatial_resolution = "5x5 degree cells", 
                      catch_resolution = "count only") %>% 
               bind_rows(iotc_option2$metrics %>% 
                           mutate(spatial_resolution = "5x5 degree cells", 
                                  catch_resolution = "count and metric tonnes converted to count")) %>% 
               bind_rows(iotc_option3$metrics %>% 
                           mutate(spatial_resolution = "1x1 degree cells", 
                                  catch_resolution = "count only")) %>% 
               bind_rows(iotc_option4$metrics %>% 
                           mutate(spatial_resolution = "1x1 degree cells", 
                                  catch_resolution = "count and metric tonnes converted to count")) %>% 
               select(spatial_resolution, catch_resolution, rmse, rsq, mae) %>% 
               arrange(desc(rsq)) %>%
               rename(`Spatial Resolution` = spatial_resolution, 
                      `Catch Resolution` = catch_resolution,
                      `Root Mean Squared Error` = rmse, 
                      `R Squared` = rsq, 
                      `Mean Absolute Error` = mae), 
             caption = "IOTC Model Results", digits = 3)
```

```{r fig.cap= "IOTC Model Results.", fig.width= 8, fig.height=16}
# Show figures
# Fix rasterize
iotc_raster_1x1 <- raster::raster(xmx = 179.5, xmn = -179.5, ymn = -89.5, ymx = 89.5, crs = 4326, resolution = 1)
iotc_raster_5x5 <- raster::raster(xmx = 177.5, xmn = -177.5, ymn = -87.5, ymx = 87.5, crs = 4326, resolution = 5)

# True Catch - 5x5 for count
iotc_true_df_5x5_count <- iotc_option1$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iotc_raster_5x5,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iotc_true_plot_5x5_count <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iotc_true_df_5x5_count, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 1 Catch
iotc_option1_df <- iotc_option1$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iotc_raster_5x5,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iotc_option1_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iotc_option1_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# True Catch - 5x5 for count and mt
iotc_true_df_5x5_mt <- iotc_option2$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iotc_raster_5x5,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90))

iotc_true_plot_5x5_mt <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iotc_true_df_5x5_mt, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 2 Catch
iotc_option2_df <- iotc_option2$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iotc_raster_5x5,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iotc_option2_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iotc_option2_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# True Catch -1x1
iotc_true_df_1x1_count <- iotc_option3$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iotc_raster_1x1,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iotc_true_plot_1x1_count <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iotc_true_df_1x1_count, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 3 Catch
iotc_option3_df <- iotc_option3$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iotc_raster_1x1,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iotc_option3_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iotc_option3_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# True Catch -1x1 for count and mt
iotc_true_df_1x1_mt <- iotc_option4$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iotc_raster_1x1,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iotc_true_plot_1x1_mt <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iotc_true_df_1x1_mt, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 4 Catch
iotc_option4_df <- iotc_option4$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., iotc_raster_1x1,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

iotc_option4_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(iotc_option4_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Combined plot
ggdraw() + 
  draw_plot(iotc_true_plot_5x5_count, 0, 0.75, 0.5, 0.25) + 
  draw_plot(iotc_option1_plot, 0.5, 0.75, 0.5, 0.25) + 
  draw_plot(iotc_true_plot_5x5_mt, 0, 0.5, 0.5, 0.25) + 
  draw_plot(iotc_option2_plot, 0.5, 0.5, 0.5, 0.25) +
  draw_plot(iotc_true_plot_1x1_count, 0, 0.25, 0.5, 0.25) +
  draw_plot(iotc_option3_plot, 0.5, 0.25, 0.5, 0.25) +
  draw_plot(iotc_true_plot_1x1_mt, 0, 0, 0.5, 0.25) +
  draw_plot(iotc_option4_plot, 0.5, 0, 0.5, 0.25) + 
  draw_plot_label(label = c("A) Observed Catch\n(5x5 Degree Grid; count)", "B) Predicted Catch\n(5x5 Degree Grid; count)", 
                            "C) Observed Catch\n(5x5 Degree Grid; count and mt)", "D) Predicted Catch\n(5x5 Degree Grid; count and mt)", 
                            "E) Observed Catch\n(1x1 Degree Grid; count)",  "F) Predicted Catch\n(1x1 Degree Grid; count)", 
                            "G) Observed Catch\n(1x1 Degree Grid; count and mt)", "H) Predicted Catch\n(1x1 Degree Grid; count and mt)"), 
                  x = rep(c(0, 0.5), 4), y = rep(c(0.99, 0.74, 0.49, 0.24), each = 2), hjust = 0, vjust = 1)
```

# WCPFC

All bycatch data from WCPFC were reported at a 5x5 degree grid as counts.

We ran two models: 

1. WCPFC data used in its native resolution (5x5 degrees) for count.
2. WCPFC data re-distributed to a finer resolution (1x1 degree) by equally distributing the catch into 25 smaller cells. For example, if 100 blue sharks were caught in a 5x5 cell, each smaller 1x1 cell within the larger area will have a catch of 100/25 = 4 blue sharks.



```{r}
# Load data
wcpfc_option1 <- readRDS(file.path(open_loc, "5x5_count_WCPFC_untuned_trained_model.rds"))
wcpfc_option2 <- readRDS(file.path(open_loc, "1x1_count_WCPFC_untuned_trained_model.rds"))

# Show Model metrics
knitr::kable(wcpfc_option1$metrics %>%
               mutate(spatial_resolution = "5x5 degree cells") %>% 
               bind_rows(wcpfc_option2$metrics %>% 
                           mutate(spatial_resolution = "1x1 degree cells")) %>% 
               select(spatial_resolution, rmse, rsq, mae) %>% 
               arrange(desc(rsq)) %>%
               rename(`Spatial Resolution` = spatial_resolution, 
                      `Root Mean Squared Error` = rmse, 
                      `R Squared` = rsq, 
                      `Mean Absolute Error` = mae), 
             caption = "WCPFC Model Results", digits = 3)
```

```{r fig.cap= "WCPFC Model Results.", fig.width= 8, fig.height=8}
# Show figures
# Fix rasterize
wcpfc_raster_1x1 <- raster::raster(xmx = 179.5, xmn = -179.5, ymn = -89.5, ymx = 89.5, crs = 4326, resolution = 1)
wcpfc_raster_5x5 <- raster::raster(xmx = 177.5, xmn = -177.5, ymn = -87.5, ymx = 87.5, crs = 4326, resolution = 5)

# True Catch
wcpfc_true_df_5x5 <- wcpfc_option1$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., wcpfc_raster_5x5,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

wcpfc_true_plot_5x5 <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(wcpfc_true_df_5x5, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 1 Catch
wcpfc_option1_df <- wcpfc_option1$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., wcpfc_raster_5x5,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

wcpfc_option1_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(wcpfc_option1_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# True catch - 1x1
wcpfc_true_df_1x1 <- wcpfc_option2$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., wcpfc_raster_1x1,
                    field = "catch", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90)) 

wcpfc_true_plot_1x1 <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(wcpfc_true_df_1x1, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Option 2 Catch
wcpfc_option2_df <- wcpfc_option2$full_predict %>% 
  sf::st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  raster::rasterize(., wcpfc_raster_1x1,
                    field = ".final_pred", fun = sum) %>% 
  raster::extend(raster::extent(-180, 180, -90, 90))

wcpfc_option2_plot <- ggplot() + 
  geom_raster(data = raster::as.data.frame(land_low_res_moll, xy = T) %>% filter(land_low_res_moll > 0.5), mapping = aes(x=x,y=y), fill = "gray48") + 
  geom_raster(data = raster::as.data.frame(wcpfc_option2_df, xy = T), mapping = aes(x=x, y=y, fill=layer)) + 
  scale_fill_viridis_c("Catch (count;\nlog transformed)", trans = "log", na.value = NA, option = "turbo",
                       labels = function(x) sprintf("%.1f", x)) + 
  coord_sf() + 
  theme_void() + 
  theme(legend.position = "bottom", 
        legend.text = element_text(angle = -45, hjust = 0), 
        legend.title = element_text(vjust = 0.9))

# Combined plot
ggdraw() + 
  draw_plot(wcpfc_true_plot_5x5, 0, 0.5, 0.5, 0.5) + 
  draw_plot(wcpfc_option1_plot, 0.5, 0.5, 0.5, 0.5) + 
  draw_plot(wcpfc_true_plot_1x1, 0, 0, 0.5, 0.5) + 
  draw_plot(wcpfc_option2_plot, 0.5, 0, 0.5, 0.5) + 
  draw_plot_label(label = c("A) Observed Catch\n(5x5 Degree Grid)", "B) Predicted Catch\n(5x5 Degree Grid)",
                            "C) Observed Catch\n(1x1 Degree Grid)", "D) Predicted Catch\n(1x1 Degree Grid)"), 
                  x = c(0, 0.5, 0, 0.5), y = c(0.99, 0.99, 0.49, 0.49), hjust = 0, vjust = 1)
```

